 {% extends "layout.html.twig" %}

{% block title %}
    {% if orgMode %}
        {% trans %}activities.firm_activities_page_title{% endtrans %}
    {% else %}
        {% trans %}activities.my_activities_page_title{% endtrans %}
    {% endif %}
{% endblock %}

{% block css %}
    <script type="text/javascript">
        var deleteUrl="{{ url('ajaxStageDelete',{'elmt': 'activity', 'stgId' : 0}) }}";
        var adeleteUrl="{{ url('ajaxActivityDelete',{'actId' : 0}) }}";
        var rdeleteUrl="{{ url('ajaxRecurringDelete',{'rctId' : 0}) }}";
        var archiveUrl="{{ url('ajaxActivityArchive',{'actId' : 0}) }}";
        var delegateUrl = "{{ url('activityDelegate') }}";
        var requestUrl = "{{ url('activityRequest') }}";
        var resolveRequestUrl = "{{ url('activityResolveRequest',{'actId' : 0, 'action' : 'undefined'}) }}";
        var createFromTemplateUrl = "{{ url('createFromTemplate',{'tmpId' : 0}) }}";
        var activityDefinitionUrl = "{{ url('manageActivityElement', {'elmtType' : 'activity', 'elmtId' : 0}) }}";
    </script>
    <style>
        html {
            overflow-y: scroll;
        }
    </style>
{% endblock %}

{% block pagename %}
    {% if orgMode %}
        {% trans %}activities.firm_activities_page_title{% endtrans %}
    {% else %}
        {% trans %}activities.my_activities_page_title{% endtrans %}
    {% endif %}
{% endblock %}

{% block username %}
{{ currentuser.firstname }} {{ currentuser.lastname }}
{% endblock %}

{% block content %}

    {% if app.request_stack.currentrequest.get('orgId') is null %}
        {% if organization.isClient == true %}
            <div class="action-buttons">
            {% if currentuser.role != 3 %}
                <div class="button-field flex-center" style="flex-direction: column">
                    {% if currentuser.role != 2 %}
                        {% if orgMode %}
                            <a href="{{ url('myActivities') }}" class="btn-large waves-effect waves-light teal lighten-1" style="margin:20px 0px 0px 0px">{% trans %}activities.my_activities{% endtrans %}</a>
                        {% else %}
                            <a href="{{ url('firmActivities') }}" class="btn-large waves-effect waves-light teal lighten-1" style="margin:20px 0px 0px 0px">{% trans %}activities.firm_activities{% endtrans %}</a>
                        {% endif %}
                    {% endif %}
                </div>
            {% else %}
                <div class="button-field">
                    <a class="waves-effect waves-green btn-large teal lighten-1 modal-trigger" href="#requestActivity" style="margin:20px 0px">{% trans %}activities.request.modal_btn_msg{% endtrans %}</a>
                </div>
                <div id="requestActivity" class="modal">
                    {{ form_start(requestForm) }}
                    <div class="modal-content">
                        <h5>{% trans %}activities.request.title_msg{% endtrans %}</h5>
                        <p>{% trans %}activities.request.content_msg{% endtrans %}</p>
                        {{ form_row(requestForm.activityName) }}
                        {{ form_row(requestForm.activityDescription) }}
                        {{ form_row(requestForm.requestType) }}
                        {{ form_row(requestForm.specificRecipients) }}
                        {{ form_widget(requestForm.discloseRequester) }}
                        {{ form_label(requestForm.discloseRequester) }}
                    </div>
                    <div class="modal-footer action-buttons">
                        <div class="button-field">
                            <a class=" modal-action modal-close submit-button waves-effect waves-red red btn-large">{% trans %}activities.request.cancel_btn_msg{% endtrans %}</a>
                        </div>
                        <div class="button-field">
                            {{ form_row(requestForm.submit) }}
                        </div>
                    </div>
                    {{ form_rest(requestForm) }}
                    {{ form_end(requestForm) }}
                </div>
                <div id="requestSuccess" class="modal">
                    <div class="modal-content">
                        <p>{% trans %}activities.request.success_msg{% endtrans %}</p>
                    </div>
                    <div class="modal-footer action-buttons">
                        <div class="button-field">
                            <a class="modal-close waves-effect waves-green btn-large">{% trans %}activities.request.success_close_btn_msg{% endtrans %}</a>
                        </div>
                    </div>
                </div>
            {% endif %}
          </div>
        {% endif %}
        {% else %}
            <h4 style="text-align: center">{{ organization.commname }} </h4>
        {% endif %}

        <ul class="tabs tabs-fixed-width">
            {% if cancelledActivities|length > 0 %}
            <li class="tab">
                <a href="#cancelled">
                    <i class="far fa-hand-point-up"></i>
                    <span class="activity-status">{% trans %}activities.cancelled{% endtrans %}</span>
                    (<span>{{ cancelledActivities|length }}</span>)
                </a>
            </li>
            {% endif %}
            {% if discardedActivities|length > 0 %}
            <li class="tab">
                <a href="#discarded">
                    <i class="fa fa-exclamation-triangle"></i>
                    <span class="activity-status">{% trans %}activities.discarded{% endtrans %}</span>
                    (<span>{{ discardedActivities|length }}</span>)
                </a>
            </li>
            {% endif %}
            {% if requestedActivities|length > 0 %}
            <li class="tab">
                <a href="#requested">
                    <i class="fa fa-gavel"></i>
                    <span class="activity-status">{% trans %}activities.requested{% endtrans %}</span>
                    (<span>{{ requestedActivities|length }}</span>)
                </a>
            </li>
            {% endif %}
            {% if attributedActivities|length > 0 %}
            <li class="tab">
                <a href="#attributed">
                    <i class="far fa-flag"></i>
                    <span class="activity-status">{% trans %}activities.attributed{% endtrans %}</span>
                    (<span>{{ attributedActivities|length }}</span>)
                </a>
            </li>
            {% endif %}
            {% if incompleteActivities|length > 0 %}
            <li class="tab">
                <a href="#incomplete">
                    <i class="far fa-edit"></i>
                    <span class="activity-status">{% trans %}activities.incomplete{% endtrans %}</span>
                    (<span>{{ incompleteActivities|length }}</span>)
                </a>
            </li>
            {% endif %}
            {% if currentActivities|length > 0 %}
            <li class="tab">
                <a href="#current"
                class="active"><i class="fa fa-hourglass-2"></i>
                <span class="activity-status">{% trans %}activities.current{% endtrans %}</span>
                (<span>{{ currentActivities|length }}</span>)
            </a>
        </li>
        {% endif %}
            {% if futureActivities|length > 0 %}
            <li class="tab">
                <a href="#future">
                    <i class="fa fa-hourglass-1"></i>
                    <span class="activity-status">{% trans %}activities.future{% endtrans %}</span>
                    (<span>{{ futureActivities|length }}</span>)
                </a>
            </li>
            {% endif %}
            {% if (completedActivities|length + releasedActivities|length) > 0 %}
            <li class="tab">
                <a href="#completed">
                    <i class="fa fa-hourglass-3 fa-tabs" ></i>
                    <span class="activity-status">{% trans %}activities.completed{% endtrans %}</span>
                    (<span>{{ completedActivities|length + releasedActivities|length }}</span>)
                </a>
            </li>
        {% endif %}
    </ul>

  {# get current date to compare it after #}
  {% set now = "now"|date("Y/m/d") %}
  {% if releasedActivities is not defined %}
      {% set completedAndReleasedActivities = completedActivities %}
  {% elseif completedActivities is not defined %}
      {% set completedAndReleasedActivities = releasedActivities %}
  {% else %}
      {% set completedAndReleasedActivities = completedActivities|merge(releasedActivities) %}
  {% endif %}



  {% if cancelledActivities|length > 0 %}

      <div id="cancelled" class="col s12">
         <div class="c-align p-tb-10">
             <i class="far fa-2x fa-hand-point-up activity-status"></i><h4>{% trans %}activities.cancelled_title{% endtrans %}</h4>
         </div>

         {% for cancelledActivity in cancelledActivities %}

             <ul id="activityList{{ cancelledActivity.id }}" class="collapsible expandMore expandLess" data-collapsible="accordion">
                 <li>
                     <div class="collapsible-header flex-center{% if cancelledActivities|length == 1 %} active {% endif %}lighten-5">
                         <i class="fa fa-fw fa-chevron-down"></i>
                         <i class="fa fa-fw fa-chevron-right"></i>
                         <div class="activity-banner">
                             <div class="activity-title"> {{ cancelledActivity.name }} {% if cancelledActivity.recurring %}<i class="far fa-2x fa-circle-notch fa-recurring tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.recurring{% endtrans %}" data-delay="50" style="margin-left:10px;"></i>{% endif %}</div>
                             <div class="activity-description"> {{ cancelledActivity.objectives  }}</div>
                         </div>
                     </div>

                     <div class="collapsible-body">
                         <div class="collapse" id="details">
                             <ul class="flex-center row" style="justify-content: space-between;">
                                 <li><h4 class="department-name no-margin">{% trans %}activities.details{% endtrans %}</h4></li>
                                  {% if cancelledActivity.deletable %}
                                      <li style="margin-left:auto;"><a href="#deleteAModal" class="waves-effect waves-light red accent-4 btn white-text modal-trigger" data-aid="{{ cancelledActivity.id }}">{% trans %}activities.delete_activity_btn{% endtrans %}</a></li>
                                   {% endif %}
                             </ul>
                         </div>
                         <ul class="collection">
                             {% set activityHasResults = false %}
                             {% set nbParticipatingReleases = 0 %}
                             {% for stage in cancelledActivity.stages %}
                                 <li class="collection-item">
                                     <div class="row action-buttons">
                                         <div class="button-field">
                                             <a class="btn-large waves-effect waves-light teal lighten-1 submit-button archive" data-id="{{ cancelledActivity.id }}"> {% trans %}activities.request_archive{% endtrans %} </a>
                                         </div>
                                     </div>
                                 </li>
                             {% endfor %}
                         </ul>
                     </div>
                 </li>
             </ul>

         {% endfor %}

      </div>

  {% endif %}

  {% if discardedActivities|length > 0 %}

      <div id="discarded" class="col s12">
          <div class="c-align p-tb-10">
              <i class="fa fa-2x fa-exclamation-triangle activity-status"></i><h4>{% trans %}activities.discarded_title{% endtrans %}</h4>
          </div>

          {% for discardedActivity in discardedActivities %}

              <ul id="activityList{{ discardedActivity.id }}" class="collapsible expandMore expandLess" data-collapsible="accordion">
                  <li>
                      <div class="collapsible-header flex-center{% if discardedActivities|length == 1 %} active {% endif %}lighten-5">
                          <i class="fa fa-fw fa-chevron-down"></i>
                          <i class="fa fa-fw fa-chevron-right"></i>
                          <div class="activity-banner">
                              <div class="activity-title"> {{ discardedActivity.name }} {% if discardedActivity.recurring %}<i class="far fa-2x fa-circle-notch fa-recurring tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.recurring{% endtrans %}" data-delay="50" style="margin-left:10px;"></i>{% endif %}</div>
                              <div class="activity-description"> {{ discardedActivity.objectives  }}</div>
                          </div>
                      </div>

                      <div class="collapsible-body">
                          <div class="collapse" id="details">
                              <ul class="flex-center row" style="justify-content: space-between;">
                                  <li><h4 class="department-name no-margin">{% trans %}activities.details{% endtrans %}</h4></li>
                                   {% if discardedActivity.deletable %}
                                      <li style="margin-left:auto;"><a href="#deleteAModal" class="waves-effect waves-light red accent-4 btn white-text modal-trigger" data-aid="{{ discardedActivity.id }}">{% trans %}activities.delete_activity_btn{% endtrans %}</a></li>
                                   {% endif %}
                              </ul>
                          </div>
                          <ul class="collection">
                              {% set activityHasResults = false %}
                              {% set nbParticipatingReleases = 0 %}
                              {% for stage in discardedActivity.stages %}
                                  <li class="collection-item">
                                      <div class="row action-buttons">
                                          <div class="button-field">
                                              <a class="btn-large waves-effect waves-light teal lighten-1 modal-trigger" href="#restoreModal-{{ discardedActivity.id }}"> {% trans %}activities.request_restore{% endtrans %} </a>
                                          </div>
                                          <div class="button-field">
                                              <a class="btn-large waves-effect waves-light teal lighten-1 submit-button archive" data-id="{{ discardedActivity.id }}"> {% trans %}activities.request_archive{% endtrans %} </a>
                                          </div>
                                      </div>
                                  </li>
                              {% endfor %}
                          </ul>
                      </div>
                  </li>
              </ul>

          {% endfor %}

      </div>

  {% endif %}

  {% if requestedActivities|length > 0 %}

      <div id="requested" class="col s12">
          <div class="c-align p-tb-10">
              <i class="fa fa-2x fa-gavel activity-status"></i><h4>{% trans %}activities.requested_title{% endtrans %}</h4>
          </div>

          {% for requestedActivity in requestedActivities %}


              {# if user has a requested Activity, we need to determine whether he is the Requester or Decider #}
              {% if requestedActivity.status == -3 %}
                  {% set break = false %}
                  {% set isDecider = false %}
                  {% for decision in requestedActivity.decisions if not break %}
                      {% if decision.decider == currentuser.id %}
                          {% set break = true %}
                          {% set isDecider = true %}
                      {% endif %}
                  {% endfor %}
              {% endif %}

              <ul id="activityList{{ requestedActivity.id }}" class="collapsible expandMore expandLess" data-collapsible="accordion">
                  <li>
                      <div class="collapsible-header flex-center{% if requestedActivities|length == 1 %} active{% endif %}{% if isDecider == false %} indigo{% else %} teal{% endif %} lighten-5">
                          <i class="fa fa-fw fa-chevron-down"></i>
                          <i class="fa fa-fw fa-chevron-right"></i>
                          <div class="activity-banner">
                              <div class="activity-title"> {{ requestedActivity.name }} {% if requestedActivity.recurring %}<i class="far fa-2x fa-circle-notch fa-recurring tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.recurring{% endtrans %}" data-delay="50" style="margin-left:10px;"></i>{% endif %}</div>
                              {#{% if requestedActivity.status != -3 %}#}
                                  <div class="activity-description"> {{ requestedActivity.objectives  }}</div>
                              {#{% endif %}#}
                          </div>
                      </div>

                      <div class="collapsible-body">
                          <div class="collapse" id="details">
                              <ul class="flex-center row" style="justify-content: space-between;">
                                  <li><h4 class="department-name no-margin">{% trans %}activities.details{% endtrans %}</h4></li>
                                   {% if requestedActivity.deletable %}
                                      <li style="margin-left:auto;"><a href="#deleteAModal" class="waves-effect waves-light red accent-4 btn white-text modal-trigger" data-aid="{{ requestedActivity.id }}">{% trans %}activities.delete_activity_btn{% endtrans %}</a></li>
                                   {% endif %}
                              </ul>
                          </div>
                          <ul class="collection">
                              <li class="collection-item">
                                  <div class="row">
                                      <div class="col s6 m4">
                                          <i class="far fa-comments" aria-hidden="true"></i> {% trans %}activities.request.comments{% endtrans %}
                                      </div>
                                      <div class="col s6 m4">{{ requestedActivity.objectives  }}</div>
                                  </div>

                                  <div class="row">
                                      <div class="col s10 m4">
                                          <i class="fa fa-users" aria-hidden="true"></i>{% if not isDecider %} {% trans %}activities.request.validators{% endtrans %}{% else %}{% trans %}activities.request.requester{% endtrans %}{% endif %}
                                      </div>
                                      <div class="col s2 m4">
                                          {% if not isDecider %}
                                              {{ requestedActivity.decisions|length }}
                                          {% else %}
                                              {% if requestedActivity.decisions[0].anonymousRequest %}
                                                  {{ requestedActivity.decisions[0].requesterUser.firstname }} {{ requestedActivity.decisions[0].requesterUser.lastname }}
                                              {% else %}
                                                  {% trans %}activities.request.anonymous_requester{% endtrans %}
                                              {% endif %}
                                          {% endif %}
                                      </div>
                                  </div>

                                  {% if not isDecider %}
                                      <div class="row no-margin">
                                          <ul class="participants">
                                              {% for decision in requestedActivity.decisions %}
                                                  <li class="participant">

                                                    <img class="user-picture tooltipped" src="{{ (decision.deciderUser.picture is not null) ? asset('lib/img/' ~ decision.deciderUser.picture) : asset('lib/img/no-picture.png') }}" data-position="top" data-tooltip="{{ decision.deciderUser.fullname }}" data-delay="50" alt="">
                                                      <div class="participant-name">
                                                          <span>{{ decision.deciderUser.firstname }}</span>
                                                      </div>
                                                  </li>
                                              {% endfor %}
                                          </ul>
                                      </div>
                                  {% endif %}
                                  <br>
                                  <div class="row action-buttons">
                                      <div class="button-field">
                                      {% if currentuser.role == 3 and isDecider == false %}
                                          <a class="btn-large waves-effect waves-light red accent-4 modal-trigger" data-aid="{{ requestedActivity.id }}" href="#cancelModal"> {% trans %}activities.request_delete{% endtrans %} </a>
                                      {% elseif isDecider == true %}
                                          <a class="btn-large waves-effect waves-light red accent-4 modal-trigger" data-aid="{{ requestedActivity.id }}" href="#discardModal"> {% trans %}activities.request_discard{% endtrans %} </a>
                                          </div>
                                          <div class="button-field">
                                          <a class="btn-large waves-effect waves-light teal lighten-1 modal-trigger" data-aid="{{ requestedActivity.id }}" data-aname="{{ requestedActivity.name }}" data-adescription="{{ requestedActivity.objectives }}" href="#validateModal"> {% trans %}activities.request_validate{% endtrans %} </a>
                                      {% endif %}
                                      </div>
                                  </div>
                              </li>
                          </ul>
                      </div>
                  </li>
              </ul>
          {% endfor %}
      </div>

  {% endif %}
  {% if attributedActivities|length > 0 %}

      <div id="attributed" class="col s12">
          <div class="c-align p-tb-10">
              <i class="far fa-2x fa-flag activity-status"></i><h4>{% trans %}activities.attributed_title{% endtrans %}</h4>
          </div>

          {% for attributedActivity in attributedActivities %}

              <ul id="activityList{{ attributedActivity.id }}" class="collapsible expandMore expandLess" data-collapsible="accordion">
                  <li>
                      <div class="collapsible-header flex-center{% if attributedActivities|length == 1 %} active{% endif %} purple lighten-5">
                          <i class="fa fa-fw fa-chevron-down"></i>
                          <i class="fa fa-fw fa-chevron-right"></i>
                          <!-- just giving the name an absolute position because it was interfering ith the button position -->
                          <div class="activity-banner">
                              <div class="activity-title"> {{ attributedActivity.name }} {% if attributedActivity.recurring %}<i class="far fa-2x fa-circle-notch fa-recurring tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.recurring{% endtrans %}" data-delay="50" style="margin-left:10px;"></i>{% endif %}</div>
                                  <div class="activity-description"> {{ attributedActivity.objectives  }}</div>
                          </div>
                      </div>

                      <div class="collapsible-body">
                          <div class="collapse" id="details">
                              <ul class="flex-center row" style="justify-content: space-between;">
                                  <li><h4 class="department-name no-margin">{% trans %}activities.details{% endtrans %}</h4></li>
                                   {% if attributedActivity.deletable %}
                                      <li style="margin-left:auto;"><a href="#deleteAModal" class="waves-effect waves-light red accent-4 btn white-text modal-trigger" data-aid="{{ attributedActivity.id }}">{% trans %}activities.delete_activity_btn{% endtrans %}</a></li>
                                   {% endif %}
                              </ul>
                          </div>
                          <ul class="collection">
                              <li class="collection-item">
                                  <div class="row">
                                      <div class="col s6 m4">
                                          <i class="far fa-comments" aria-hidden="true"></i> {% trans %}activities.request.comments{% endtrans %}
                                      </div>
                                      <div class="col s6 m4">{{ attributedActivity.objectives  }}</div>
                                  </div>
                                  <br>
                                  <div class="row action-buttons">
                                      <div class="button-field">
                                          <a class="btn-large waves-effect waves-light teal lighten-1" href="{{ url('manageActivityElement',{'elmtType' : 'activity', 'elmtId' : attributedActivity.id}) }}"> {% trans %}activities.define{% endtrans %} </a>
                                      </div>
                                  </div>
                              </li>
                          </ul>
                      </div>
                  </li>
              </ul>
          {% endfor %}
      </div>
  {% endif %}

  {% if incompleteActivities|length > 0 %}

      <div id="incomplete" class="col s12">
          <div class="c-align p-tb-10">
              <i class="fas fa-2x fa-edit activity-status"></i><h4>{% trans %}activities.incomplete_title{% endtrans %}</h4>
          </div>
            {% for incompleteActivity in incompleteActivities %}

                {% set activityMixed = false %}
                {% set activityType = incompleteActivity.stages[0].criteria[0].type %}
                {% set diffGradingDays = null %}
                {% set diffStageDays = -1 %}
                {% set oldestStageStartDate = incompleteActivity.stages[0].startdate|date("Y/m/d") %}
                {% set newestStageEndDate = incompleteActivity.stages[0].enddate|date("Y/m/d") %}
                {% for stage in incompleteActivity.stages if not activityMixed %}

                    {% set diffStageDateInterval = stage.genddate.diff(date(now)) %}

                    {% set diffGradingDays = diffStageDateInterval.days %}
                    {% if stage.genddate|date("Y/m/d") < now %}
                        {% set diffGradingDays = -diffGradingDays %}
                    {% endif %}

                    {% if diffGradingDays > diffStageDays %}
                        {% set diffStageDays = diffGradingDays %}
                    {% endif %}
                    {% for criterion in stage.criteria if not activityMixed %}
                        {% if criterion.type != activityType %}
                            {% set activityMixed = true %}
                        {% endif %}
                    {% endfor %}
            {% endfor %}


              <ul id="activityList{{ incompleteActivity.id }}" class="collapsible expandMore expandLess" data-collapsible="accordion">
                  <li>
                      <div class="collapsible-header flex-center{% if incompleteActivities|length == 1 %} active{% endif %} blue lighten-5">
                          <i class="fa fa-fw fa-chevron-down"></i>
                          <i class="fa fa-fw fa-chevron-right"></i>
                          <div class="activity-banner">
                              <div class="activity-title"> {{ incompleteActivity.name }} {% if incompleteActivity.recurring %}<i class="far fa-2x fa-circle-notch fa-recurring tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.recurring{% endtrans %}" data-delay="50" style="margin-left:10px;"></i>{% endif %}</div>
                              {#<div class="activity-description"> {{ incompleteActivity.objectives  }}</div>#}
                          </div>


                          <div style="margin-left:auto;">
                              <ul style="display:flex;align-items:center;">

                                  <li>
                                      <ul style="display: flex;align-items: center;flex-direction:column-reverse; margin-right:5px;" class="tooltipped" data-position="top" data-tooltip="{% if diffStageDays is defined %}{% if diffStageDays >= 0 %}{% trans %}tooltip.activity.grading_deadline.start_msg{% endtrans %} {{ diffStageDays }} {% trans %}tooltip.activity.grading_deadline.end_msg{% endtrans %}{% else %}{% trans %}tooltip.activity.grading_deadline.expired{% endtrans %}{% endif %}{% endif %}">
                                          {% if diffStageDays >= 0 %}<li>{{ diffStageDays }}</li>{% endif %}
                                          <li><i class="far fa-2x fa-clock {% if diffStageDays < 0 %}red-text{% endif %}" style="margin:0!important;"></i></li>
                                      </ul>
                                  </li>

                                  {% set activityProgress = 0 %}
                                  {% set nbFinalizedStages = 0 %}
                                  {% for stage in incompleteActivity.stages %}
                                      {% set activityProgress = activityProgress + stage.gradingProgress * 100 %}
                                  {% endfor %}
                                  {% if incompleteActivity.stages|length > 0 %}
                                      {% set activityProgress = activityProgress / incompleteActivity.stages|length %}
                                  {% endif %}

                                    <ul style="display:flex;flex-direction: column";>
                                        <ul style="display:flex;flex-direction: row;align-items: center;margin: 0;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.activity_progress{% endtrans %}: {{ min(100, (100 * date(incompleteActivity.startdate).diff(date(now)).days / max(1, date(incompleteActivity.startdate).diff(date(incompleteActivity.enddate)).days))|round(0)) }} %" data-delay="50">
                                            <li><i class="far fa-calendar-alt" style="margin: 0;font-size: 1.3rem"></i></li>
                                            <li class="progress" style="width:30px;margin:0px 10px 0px 0px;background-color:#b7bbbb;">
                                                <div class="determinate"
                                                    style="width: {{ min(100, (100 * date(incompleteActivity.startdate).diff(date(now)).days / max(1,date(incompleteActivity.startdate).diff(date(incompleteActivity.enddate)).days))|round(0)) }}%;background-color: black;"></div>
                                            </li>
                                        </ul>
                                        <ul style="display:flex;flex-direction: row;align-items: center" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.grading_progress{% endtrans %}: {{ activityProgress|round(0) }} %" data-delay="50">
                                            <li><i class="fa fa-pencil-alt" style="margin: 0;font-size: 1.3rem"></i></li>
                                            <li class="progress" style="width:30px;margin:0px 10px 0px 0px;background-color:#b7bbbb;">
                                                <div class="determinate"
                                                    style="width: {{ activityProgress|round(0) }}%;background-color: black;"></div>
                                            </li>
                                        </ul>
                                    </ul>


                                  {% if activityMixed %}
                                      <li><i class="fa fa-2x fa-map-signs tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.mixed{% endtrans %}" data-delay="50"></i></li>
                                  {% else %}
                                      {% if activityType is defined %}
                                          {% if activityType == 0 %}
                                              <li><i class="fa fa-2x fa-pie-chart tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.contrib{% endtrans %}" data-delay="50"></i></li>
                                          {% elseif activityType == 1 %}
                                              <li><i class="fas fa-2x fa-tachometer-alt tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.eval{% endtrans %}" data-delay="50"></i></li>
                                          {% elseif activityType == 2 %}
                                              <li><i class="fas fa-2x fa-comment-dots tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.pureFeedback{% endtrans %}" data-delay="50"></i></li>
                                          {% endif %}
                                      {% else %}
                                          <li></li>
                                      {% endif %}
                                  {% endif %}

                                  {% if incompleteActivity.hasParticipants == false %}
                                  <li style="position:relative"><i class="fa fa-2x fa-users tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.missing_participants{% endtrans %}" data-delay="50"></i><div class="bar"></div></li>
                                  {% elseif incompleteActivity.isFinalized == false %}
                                  <li><i class="far fa-2x fa-paper-plane tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.not_finalized{% endtrans %}" data-delay="50"></i></li>
                                  {% endif %}
                                  <li class="flex-center tooltipped" style="background-color: purple;color: white;width: 23px; height: 23px; border-radius: 100%;justify-content:center" data-position="top" data-tooltip="{% trans %}tooltip.activity.magnitude{% endtrans %}" data-delay="50">
                                    <span>{{incompleteActivity.magnitude}}</span>
                                  </li>
                              </ul>
                          </div>

                      </div>

                      <div class="collapsible-body">
                          <div class="collapse" id="details">
                              <ul class="flex-center row" style="justify-content: space-between;">
                                  <li><h4 class="department-name no-margin">{% trans %}activities.details{% endtrans %}</h4></li>
                                  {# Suppress element is only possible : if activity is not requested/attributed/, user is not a collaborator and stage has not been fully graded, and if user... has root privileges :p #}
                                  {% if incompleteActivity.deletable %}
                                      <li style="margin-left:auto;"><a href="#deleteAModal" class="waves-effect waves-light red accent-4 btn white-text modal-trigger" data-aid="{{ incompleteActivity.id }}">{% trans %}activities.delete_activity_btn{% endtrans %}</a></li>
                                  {% endif %}
                              </ul>
                          </div>
                          <ul class="collection">

                              {% set activityHasResults = false %}
                              {% set nbParticipatingReleases = 0 %}
                              {% for stage in incompleteActivity.stages %}

                                    {% set selectedTeam = null %}
                                  <li class="collection-item">

                                      {% if incompleteActivity.stages|length > 1 %}
                                          <ul class="flex-center row" style="justify-content: space-between;">
                                              <li><h4 class="department-name no-margin">{{ stage.name }}</h4></li>
                                              {% if stage.modifiable and currentuser.role != 3 %}
                                                  <li style="margin-left:auto;"><a href="#deleteASModal" class="waves-effect waves-light red accent-4 btn white-text modal-trigger" data-sid="{{ stage.id }}">{% trans %}activities.delete_stage_btn{% endtrans %}</a></li>
                                              {% endif %}
                                          </ul>

                                      {% endif %}
                                      <div class="row">
                                        <div class="col s6 m4">
                                              <i class="fa fa-cube" aria-hidden="true"></i> {% trans %}activities.criteria{% endtrans %}
                                        </div>
                                        <div class="col s6 m8">
                                            <ul class="flex-center">
                                            {% for criterion in stage.criteria %}
                                                <li>
                                                    {% set icon = criterion.cName.icon %}
                                                    {% set iconHtml = '' %}
                                                    {% set iconClass = 'fa fa-cube' %}

                                                    {% if icon is not null %}
                                                        {% if icon.type != 'm' %}
                                                            {% set iconClass = 'fa fa-' ~ icon.name %}
                                                        {% else %}
                                                            {% set iconClass = 'material-icons' %}
                                                            {% set iconHtml = icon.name %}
                                                        {% endif %}
                                                    {% endif %}

                                                    <i  class="{{ iconClass }} tooltipped"
                                                        data-position="top"
                                                        data-tooltip="{{ criterion.cName.name }}"
                                                        style="font-size: 1.3rem !important; margin-right: 10px;">{{ iconHtml }}</i>
                                                </li>
                                            {% endfor %}
                                            </ul>
                                        </div>
                                      </div>
                                      <div class="row">
                                          <div class="col s6 m4">
                                              <i class="far fa-clock" aria-hidden="true"></i> {% trans %}activities.activity_period{% endtrans %}
                                          </div>
                                          <div class="col s6 m4 desktop-dates">{{ stage.startdate|localizeddate('long', 'none') }} - {{ stage.enddate|localizeddate('long', 'none') }}</div>
                                          <div class="col s6 m4 mobile-dates">{{ stage.startdate|localizeddate('short', 'none', null, null, 'dd/MM') }} - {{ stage.enddate|localizeddate('short', 'none', null, null, 'dd/MM') }}</div>
                                      </div>
                                      <div class="row">
                                          <div class="col s6 m4">
                                              <i class="far fa-clock" aria-hidden="true"></i> {% trans %}activities.grading_period{% endtrans %}
                                          </div>
                                          <div class="col s6 m4 desktop-dates">{{ stage.gstartdate|localizeddate('long', 'none') }} - {{ stage.genddate|localizeddate('long', 'none') }}</div>
                                          <div class="col s6 m4 mobile-dates">{{ stage.gstartdate|localizeddate('short', 'none', null, null, 'dd/MM') }} - {{ stage.genddate|localizeddate('short', 'none', null, null, 'dd/MM') }}</div>
                                      </div>
                                      <div class="row">
                                          <div class="col s12 m4">
                                              <i class="fa fa-tasks" aria-hidden="true"></i> {% trans %}activities.progress{% endtrans %}
                                          </div>
                                          <div class="col s9 m4">
                                              <div class="progress">
                                                  <div class="determinate" style="width: {{ (stage.gradingProgress * 100)|round(0) }}%"></div>
                                              </div>
                                          </div>
                                          <div class="col s3 m3">
                                              {{ (stage.gradingProgress * 100)|round(0) }}%
                                          </div>
                                      </div>
                                      {% if stage.criteria[0] is defined %}
                                          <div class="row">
                                              <div class="col s10 m4">
                                                  <i class="fa fa-users" aria-hidden="true"></i>{% trans %}activities.participants{% endtrans %}
                                              </div>
                                              <div class="col s2 m4">
                                                  {{ stage.distinctParticipations|length }}
                                              </div>
                                          </div>
                                          <div class="row no-margin">
                                              <ul class="participants">
                                                  {% set allMembersHaveValidatedGrades = null %}
                                                  {% for pkey, participant in stage.distinctParticipations %}
                                                        {% set user = participant.user(app) %}
                                                        {% set isExternal = false %}
                                                        {% set extUser = null %}


                                                        {% if currentuser.orgId != user.orgId %}
                                                            {% set isExternal = true %}
                                                            {% set break = false %}
                                                            {% for externalUser in user.externalUsers if not break %}
                                                                {% if externalUser.organization.id == currentuser.orgId %}
                                                                    {% set break = true %}
                                                                    {% set extUser = externalUser %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% endif %}
                                                        {% if participant.team is null %}
                                                          <li class="participant" style="position: relative">
                                                              <ul class="flex-center" style="flex-direction: column">
                                                                  <li>
                                                                      <div class="picture-frame">
                                                                        <img class="user-picture {{ not isExternal ?'tooltipped' }}" src="{{ (user.picture is not null) ? asset('lib/img/' ~ user.picture) : asset('lib/img/no-picture.png') }}" data-position="top" data-tooltip="{{ not isExternal ? user.fullname}}" data-delay="50" alt="">
                                                                      </div>
                                                                  </li>
                                                                  <li>
                                                                      <div class="participant-name">
                                                                           <span>
                                                                            {% if isExternal == true and extUser is not null %}
                                                                                {% if extUser.firstname != null %}
                                                                                    {{ extUser.firstname }}
                                                                                    {% if extUser.deleted != null %}
                                                                                        <span style="color: black;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.deleted_user{% endtrans %}" data-delay="50">†</span>
                                                                                    {% endif %}
                                                                                {% else %}
                                                                                    {{ user.organization(app).commname }}
                                                                                {% endif %}
                                                                            {% else %}
                                                                                {% if user.deleted != null %}
                                                                                        <span style="color: black;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.deleted_user{% endtrans %}" data-delay="50">†</span>
                                                                                {% endif %}
                                                                                {{ stage.uniqueParticipantNames[pkey] }}
                                                                            {% endif %}
                                                                            </span>
                                                                            {% if isExternal == true and extUser is not null %}
                                                                                <span style="background-color: #26A69A;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.external_user_msg{% endtrans %}" data-delay="50">E</span>
                                                                            {% endif %}
                                                                          {% if participant.type == 0 %}
                                                                            <span style="background-color: purple;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.tp_participant_msg{% endtrans %}" data-delay="50">T</span>
                                                                          {% elseif participant.type == -1 %}
                                                                            <span style="background-color: orange;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.passive_participant_msg{% endtrans %}" data-delay="50">P</span>
                                                                          {% endif %}
                                                                          {% if participant.precomment is not null and participant.precomment != "" %}
                                                                            <i class="fa fa-flag tooltipped" data-position="top" data-tooltip="{{ participant.precomment }}" data-delay="50" style="color:#15a6ae;" title="{% trans %}grade.precomment.button_existing_title{% endtrans %}"></i>
                                                                          {% endif %}
                                                                          {% if participant.status == 3 and stage.status < 2 %}
                                                                            <i class="material-icons green-text tooltipped" style="font-size:16px" data-position="top" data-tooltip="{% trans %}tooltip.activity.validated_grades{% endtrans %}" data-delay="50">check_circle</i>
                                                                          {% endif %}
                                                                          {% if participant.leader %}
                                                                              <i class="fa fa-star tooltipped" style="font-size:16px" data-position="top" data-tooltip="{% trans %}participants.leader{% endtrans %}" data-delay="50"></i>
                                                                          {% endif %}
                                                                      </div>
                                                                  </li>
                                                              </ul>
                                                          </li>
                                                      {% else %}
                                                          {% if selectedTeam is null or selectedTeam != participant.team %}
                                                                {% set selectedTeam = participant.team %}

                                                                {% if stage.status < 2 and allMembersHaveValidatedGrades == null %}

                                                                    {% set break = false %}
                                                                    {% for teamParticipant in stage.distinctParticipations if not break %}
                                                                        {% if teamParticipant.team is not null and teamParticipant.status < 3 %}
                                                                            {% set break = true %}
                                                                            {% set allMembersHaveValidatedGrades = false %}
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                    {% if break == false %}
                                                                        {% set allMembersHaveValidatedGrades = true %}
                                                                    {% endif %}

                                                                {% endif %}


                                                              <li class="participant" style="position: relative">
                                                                <ul class="flex-center" style="flex-direction: column">
                                                                    <li>
                                                                        {% if participant.team.picture != "" and participant.team.picture is not null %}
                                                                            <div class="picture-frame">
                                                                                <img class="user-picture" src="{{ participant.team.picture }}" alt="">
                                                                            </div>
                                                                        {% else %}
                                                                            <div class="picture-frame flex-center" style="background-color: #b3b3b3; border-radius: 100%; height: 50px; justify-content: center">
                                                                                <i class="fa fa-users" style="color: white; font-size: 1.5rem; margin: 0px;"></i>
                                                                            </div>
                                                                        {% endif %}
                                                                    </li>
                                                                    <li>
                                                                        <div class="participant-name">
                                                                            <span>{{ participant.team.name }}</span>
                                                                            {% if participant.type == 0 %}
                                                                                <span style="background-color: purple;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.tp_participant_msg{% endtrans %}" data-delay="50">T</span>
                                                                            {% elseif participant.type == -1 %}
                                                                                <span style="background-color: orange;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.passive_participant_msg{% endtrans %}" data-delay="50">P</span>
                                                                            {% endif %}
                                                                            {% if participant.precomment is not null and participant.precomment != "" %}
                                                                                <i class="fa fa-flag tooltipped" data-position="top" data-tooltip="{{ participant.precomment }}" data-delay="50" style="color:#15a6ae;" title="{% trans %}grade.precomment.button_existing_title{% endtrans %}"></i>
                                                                            {% endif %}
                                                                            {% if allMembersHaveValidatedGrades == true %}
                                                                                <i class="material-icons green-text tooltipped" style="font-size:16px" data-position="top" data-tooltip="{% trans %}tooltip.activity.validated_grades{% endtrans %}" data-delay="50">check_circle</i>
                                                                            {% endif %}
                                                                            {% if participant.leader %}
                                                                                <i class="fa fa-star tooltipped" style="font-size:16px" data-position="top" data-tooltip="{% trans %}participants.leader{% endtrans %}" data-delay="50"></i>
                                                                            {% endif %}
                                                                        </div>
                                                                    </li>
                                                                </ul>
                                                              </li>
                                                          {% endif %}
                                                      {% endif %}
                                                  {% endfor %}
                                              </ul>
                                          </div>
                                      {% endif %}

                                      <br>
                                      <div class="row action-buttons">

                                          {% if stage.status < 2 or stage.status == 2 and currentuser.role == 3 %}

                                              {% if stage.status == 2 %}
                                                  {% set activityHasResults = true %}
                                              {% endif %}

                                              {% if stage.modifiable %}
                                                  <div class="button-field">
                                                      <a class="btn-large waves-effect waves-light teal lighten-1 modify-btn" href="{{ url('manageActivityElement',{'elmtType': 'activity', 'elmtId' : incompleteActivity.id}) }}"> {% trans %}activities.modify{% endtrans %} </a>
                                                  </div>
                                              {% endif %}



                                              {% set break = false %}
                                              {% for participant in stage.participants if not break %}
                                                  {% if participant.usrId == currentuser.id and participant.type != -1 and now >= stage.gstartdate|date("Y/m/d") %}
                                                      {% if participant.isMailed == true and (participant.status >=3 or currentuser.role == 3 or participant.status < 3 and now <= stage.genddate|date("Y/m/d")) %}
                                                          {% if currentuser.role == 3 and participant.status == 4 %}
                                                              {% set nbParticipatingReleases = nbParticipatingReleases + 1 %}
                                                          {% else %}
                                                              <div class="button-field">
                                                                  <a class="btn-large waves-effect waves-light teal lighten-1 grade-btn" href="{{ url('newStageGrade',{'stgId' : stage.id})}}"> {% if participant.status == 3 %}{% trans %} activities.see_grades {% endtrans %}{% elseif participant.status == 2 or participant.status == 1 %}{% trans %} activities.finalize_grades {% endtrans %}{% else %}{% trans %}activities.grade{% endtrans %}{% endif %} </a>
                                                              </div>
                                                          {% endif %}

                                                      {% endif %}
                                                      {% set break = true %}
                                                  {% endif %}
                                              {% endfor %}


                                              {# result button displayed at the bottom of activity #}
                                              {% if stage == incompleteActivity.stages|last and (nbParticipatingReleases > 0 and currentuser.role == 3 or activityHasResults == true and currentuser.role != 3) %}
                                                  <div class="button-field">
                                                      <a class="btn-large waves-effect waves-light blue darken-4 results-btn" href="{{ url('activityResults',{'actId' : stage.activity.id}) }}" style="color: white;"><span>{% trans %}activities.results{% endtrans %}</span></a>
                                                  </div>
                                              {% endif %}

                                          {% else %}

                                              {% if stage.status == 2 %}
                                                  {% set activityHasResults = true %}
                                              {% endif %}
                                              {% if stage == incompleteActivity.stages|last and activityHasResults == true %}
                                                  <div class="button-field">
                                                      <a class="btn-large waves-effect waves-light blue darken-4 results-btn" href="{{ url('activityResults',{'actId' : stage.activity.id}) }}" style="color: white;"> {% trans %}activities.results{% endtrans %}</a>
                                                  </div>
                                              {% endif %}
                                          {% endif %}
                                      </div>
                                  </li>
                              {% endfor %}
                          </ul>
                      </div>
                  </li>
              </ul>
          {% endfor %}
      </div>

  {% endif %}
  {% if futureActivities|length > 0 %}

      <div id="future" class="col s12">
          <div class="c-align p-tb-10">
              <i class="fa fa-2x fa-hourglass-1 activity-status"></i><h4>{% trans %}activities.future_title{% endtrans %}</h4>
          </div>
          {% for futureActivity in futureActivities %}

              {% set activityMixed = false %}
              {% set activityType = futureActivity.stages[0].criteria[0].type %}
              {% set diffGradingDays = null %}
              {% set diffStageDays = -1 %}
              {% set oldestStageStartDate = futureActivity.stages[0].startdate|date("Y/m/d") %}
              {% set newestStageEndDate = futureActivity.stages[0].enddate|date("Y/m/d") %}
              {% for stage in futureActivity.stages if not activityMixed %}

                  {% set diffStageDateInterval = stage.genddate.diff(date(now)) %}

                  {% set diffGradingDays = diffStageDateInterval.days %}
                  {% if stage.genddate|date("Y/m/d") < now %}
                      {% set diffGradingDays = -diffGradingDays %}
                  {% endif %}

                  {% if diffGradingDays > diffStageDays %}
                      {% set diffStageDays = diffGradingDays %}
                  {% endif %}
                  {% for criterion in stage.criteria if not activityMixed %}
                      {% if criterion.type != activityType %}
                          {% set activityMixed = true %}
                      {% endif %}
                  {% endfor %}
              {% endfor %}

              <ul id="activityList{{ futureActivity.id }}" class="collapsible expandMore expandLess" data-collapsible="accordion">
                  <li>
                      <div class="collapsible-header flex-center{% if futureActivities|length == 1 %} active{% endif %} cyan lighten-5">
                          <i class="fa fa-fw fa-chevron-down"></i>
                          <i class="fa fa-fw fa-chevron-right"></i>
                          <!-- just giving the name an absolute position because it was interfering ith the button position -->
                          <div class="activity-banner">
                              <div class="activity-title"> {{ futureActivity.name }} {% if futureActivity.recurring %}<i class="far fa-2x fa-circle-notch fa-recurring tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.recurring{% endtrans %}" data-delay="50" style="margin-left:10px;"></i>{% endif %}</div>
                              {#<div class="activity-description"> {{ futureActivity.objectives }}</div>#}
                          </div>

                          <div style="margin-left:auto;">
                              <ul style="display:flex;align-items:center;">
                                  <li>
                                      <ul style="display: flex;align-items: center; flex-direction:column-reverse; margin-right:5px;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.grading_startdate.start_msg{% endtrans %}{% if futureActivity.startdate is defined %} {{ date(futureActivity.startdate).diff(date(now)).days}} {% else %} #N/A {% endif %}{% trans %}tooltip.activity.grading_startdate.end_msg{% endtrans %}">
                                          <li><span style="font-size:0.9rem">{% if futureActivity.startdate is defined %}{{ date(futureActivity.startdate).diff(date(now)).days }}{% else %}#N/A{% endif %}</span></li>
                                          <li><i class="far fa-2x fa-clock" style="margin:0!important;"></i></li>
                                      </ul>
                                  </li>
                                  {% if futureActivity.finalized is null %}
                                      <li><i class="material-icons tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.not_finalized{% endtrans %}" data-delay="50">pause_circle_outline</i></li>
                                  {% endif %}
                                    {# in case there is a user grading an activity belongs to another firm (external to this activity), do not apply for root user #}
                                    {% if futureActivity.organization.id != currentuser.orgId and currentuser.role != 4 %}
                                        <li>
                                            <i class="material-icons green-text tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.external{% endtrans %}" data-delay="50">call_made</i>
                                        </li>
                                  {% endif %}
                              </ul>
                          </div>
                      </div>

                      <div class="collapsible-body">
                          <div class="collapse" id="details">
                              <ul class="flex-center row" style="justify-content: space-between;">
                                  <li><h4 class="department-name no-margin">{% trans %}activities.details{% endtrans %}</h4></li>
                                  {# Suppress element is only possible : if activity is not requested/attributed/, user is not a collaborator and stage has not been fully graded or if user has root privileges #}
                                  {% if futureActivity.deletable %}
                                      <li style="margin-left:auto;"><a href="#deleteAModal" class="waves-effect waves-light red accent-4 btn white-text modal-trigger" data-aid="{{ futureActivity.id }}">{% trans %}activities.delete_activity_btn{% endtrans %}</a></li>
                                  {% endif %}
                              </ul>
                          </div>
                          <ul class="collection">

                              {% set activityHasResults = false %}
                              {% set nbParticipatingReleases = 0 %}
                              {% for stage in futureActivity.stages %}

                                    {% set selectedTeam = null %}

                                  <li class="collection-item">

                                      {% if futureActivity.stages|length > 1 %}
                                          <ul class="flex-center row" style="justify-content: space-between;">
                                              <li><h4 class="department-name no-margin">{{ stage.name }}</h4></li>
                                              {% if stage.modifiable and currentuser.role != 3 %}
                                                  <li style="margin-left:auto;"><a href="#deleteASModal" class="waves-effect waves-light red accent-4 btn white-text modal-trigger" data-sid="{{ stage.id }}">{% trans %}activities.delete_stage_btn{% endtrans %}</a></li>
                                              {% endif %}
                                          </ul>
                                      {% endif %}

                                    <div class="row">
                                        <div class="col s6 m4">
                                              <i class="fa fa-cube" aria-hidden="true"></i> {% trans %}activities.criteria{% endtrans %}
                                        </div>
                                        <div class="col s6 m8">
                                            <ul class="flex-center">
                                            {% for criterion in stage.criteria %}
                                                <li>
                                                    {% set icon = criterion.cName.icon %}
                                                    {% set iconHtml = '' %}
                                                    {% set iconClass = 'fa fa-cube' %}

                                                    {% if icon is not null %}
                                                        {% if icon.type != 'm' %}
                                                            {% set iconClass = 'fa fa-' ~ icon.name %}
                                                        {% else %}
                                                            {% set iconClass = 'material-icons' %}
                                                            {% set iconHtml = icon.name %}
                                                        {% endif %}
                                                    {% endif %}

                                                    <i  class="{{ iconClass }} tooltipped"
                                                        data-position="top"
                                                        data-tooltip="{{ criterion.cName.name }}"
                                                        style="font-size: 1.3rem !important; margin-right: 10px;">{{ iconHtml }}</i>
                                                </li>
                                            {% endfor %}
                                            </ul>
                                        </div>
                                      </div>
                                      <div class="row">
                                          <div class="col s6 m4">
                                              <i class="far fa-clock" aria-hidden="true"></i> {% trans %}activities.activity_period{% endtrans %}
                                          </div>
                                          <div class="col s6 m4 desktop-dates">{{ stage.startdate|localizeddate('long', 'none') }} - {{ stage.enddate|localizeddate('long', 'none') }}</div>
                                          <div class="col s6 m4 mobile-dates">{{ stage.startdate|localizeddate('short', 'none', null, null, 'dd/MM') }} - {{ stage.enddate|localizeddate('short', 'none', null, null, 'dd/MM') }}</div>
                                      </div>

                                      <div class="row">
                                          <div class="col s6 m4">
                                              <i class="far fa-clock" aria-hidden="true"></i> {% trans %}activities.grading_period{% endtrans %}
                                          </div>
                                          <div class="col s6 m4 desktop-dates">{{ stage.gstartdate|localizeddate('long', 'none') }} - {{ stage.genddate|localizeddate('long', 'none') }}</div>
                                          <div class="col s6 m4 mobile-dates">{{ stage.gstartdate|localizeddate('short', 'none', null, null, 'dd/MM') }} - {{ stage.genddate|localizeddate('short', 'none', null, null, 'dd/MM') }}</div>
                                      </div>

                                      <div class="row">
                                          <div class="col s12 m4">
                                              <i class="fa fa-tasks" aria-hidden="true"></i> {% trans %}activities.progress{% endtrans %}
                                          </div>
                                          <div class="col s9 m4">
                                              <div class="progress">
                                                  <div class="determinate" style="width: {{ (stage.gradingProgress * 100)|round(0) }}%"></div>
                                              </div>
                                          </div>
                                          <div class="col s3 m3">
                                              {{ (stage.gradingProgress * 100)|round(0) }}%
                                          </div>
                                      </div>

                                      <div class="row">
                                          <div class="col s10 m4">
                                              <i class="fa fa-users" aria-hidden="true"></i>{% trans %}activities.participants{% endtrans %}
                                          </div>
                                          <div class="col s2 m4">
                                              {{ stage.distinctParticipations|length }}
                                          </div>
                                      </div>

                                      <div class="row no-margin">
                                          <ul class="participants">
                                              {% for pkey, participant in stage.distinctParticipations %}
                                                    {% set user = participant.user(app) %}
                                                    {% set isExternal = false %}
                                                    {% set extUser = null %}


                                                    {% if currentuser.orgId != user.orgId %}
                                                        {% set isExternal = true %}
                                                        {% set break = false %}
                                                        {% for externalUser in user.externalUsers if not break %}
                                                            {% if externalUser.organization.id == currentuser.orgId %}
                                                                {% set break = true %}
                                                                {% set extUser = externalUser %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endif %}
                                                  {% if participant.team is null %}
                                                      <li class="participant" style="position: relative">
                                                          <ul class="flex-center" style="flex-direction: column">
                                                              <li>
                                                                  <div class="picture-frame">
                                                                    <img class="user-picture {{ not isExternal ?'tooltipped' }}" src="{{ (user.picture is not null) ? asset('lib/img/' ~ user.picture) : asset('lib/img/no-picture.png') }}" data-position="top" data-tooltip="{{ not isExternal ? user.fullname}}" data-delay="50" alt="">
                                                                  </div>
                                                              </li>
                                                              <li>
                                                                  <div class="participant-name">
                                                                          <span>
                                                                            {% if isExternal == true and extUser is not null %}
                                                                                {% if extUser.firstname != null %}
                                                                                    {{ extUser.firstname }}
                                                                                    {% if extUser.deleted != null %}
                                                                                        <span style="color: black;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.deleted_user{% endtrans %}" data-delay="50">†</span>
                                                                                    {% endif %}
                                                                                {% else %}
                                                                                    {{ user.organization(app).commname }}
                                                                                {% endif %}
                                                                            {% else %}
                                                                                {% if user.deleted != null %}
                                                                                        <span style="color: black;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.deleted_user{% endtrans %}" data-delay="50">†</span>
                                                                                {% endif %}
                                                                                {{ stage.uniqueParticipantNames[pkey] }}
                                                                            {% endif %}
                                                                        </span>
                                                                        {% if isExternal == true and extUser is not null %}
                                                                            <span style="background-color: #26A69A;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.external_user_msg{% endtrans %}" data-delay="50">E</span>
                                                                        {% endif %}
                                                                        {% if participant.type == 0 %}
                                                                            <span style="background-color: purple;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.tp_participant_msg{% endtrans %}" data-delay="50">T</span>
                                                                        {% elseif participant.type == -1 %}
                                                                            <span style="background-color: orange;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.passive_participant_msg{% endtrans %}" data-delay="50">P</span>
                                                                        {% endif %}
                                                                        {% if participant.precomment is not null and participant.precomment != "" %}
                                                                            <i class="fa fa-flag tooltipped" data-position="top" data-tooltip="{{ participant.precomment }}" data-delay="50" style="color:#15a6ae;" title="{% trans %}grade.precomment.button_existing_title{% endtrans %}"></i>
                                                                        {% endif %}
                                                                        {% if participant.leader %}
                                                                            <i class="fa fa-star tooltipped" style="font-size:16px" data-position="top" data-tooltip="{% trans %}participants.leader{% endtrans %}" data-delay="50"></i>
                                                                        {% endif %}
                                                                  </div>
                                                              </li>
                                                          </ul>
                                                      </li>
                                                  {% else %}
                                                      {% if selectedTeam is null or selectedTeam != participant.team %}
                                                           <li class="participant" style="position: relative">
                                                                <ul class="flex-center" style="flex-direction: column">
                                                                    <li>
                                                                        {% if participant.team.picture != "" and participant.team.picture is not null %}
                                                                        <div class="picture-frame">
                                                                            <img class="user-picture" src="{{ participant.team.picture }}" alt="">
                                                                        </div>
                                                                        {% else %}
                                                                            <div class="picture-frame flex-center" style="background-color: #b3b3b3; border-radius: 100%; height: 50px; justify-content: center">
                                                                                <i class="fa fa-users" style="color: white; font-size: 2rem; margin: 0px;"></i>
                                                                            </div>
                                                                        {% endif %}
                                                                    </li>
                                                                    <li>
                                                                        <div class="participant-name">
                                                                            <span>{{ participant.team.name }}</span>
                                                                            {% if participant.type == 0 %}
                                                                                <span style="background-color: purple;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.tp_participant_msg{% endtrans %}" data-delay="50">T</span>
                                                                            {% elseif participant.type == -1 %}
                                                                                <span style="background-color: orange;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.passive_participant_msg{% endtrans %}" data-delay="50">P</span>
                                                                            {% endif %}
                                                                            {% if participant.precomment is not null and participant.precomment != "" %}
                                                                                <i class="fa fa-flag tooltipped" data-position="top" data-tooltip="{{ participant.precomment }}" data-delay="50" style="color:#15a6ae;" title="{% trans %}grade.precomment.button_existing_title{% endtrans %}"></i>
                                                                            {% endif %}
                                                                            {% if participant.leader %}
                                                                                <i class="fa fa-star tooltipped" style="font-size:16px" data-position="top" data-tooltip="{% trans %}participants.leader{% endtrans %}" data-delay="50"></i>
                                                                            {% endif %}
                                                                        </div>
                                                                    </li>
                                                                </ul>
                                                            </li>
                                                             {% set selectedTeam = participant.team %}
                                                      {% endif %}
                                                  {% endif %}
                                              {% endfor %}
                                          </ul>
                                      </div>
                                      <br>
                                      {% if stage.modifiable %}
                                          <div class="row action-buttons">
                                              <div class="button-field">
                                                  <a class="btn-large waves-effect waves-light teal lighten-1 modify-btn" href="{{ url('manageActivityElement',{'elmtType' : 'activity',  'elmtId' : futureActivity.id}) }}"> {% trans %}activities.modify{% endtrans %} </a>
                                              </div>
                                          </div>
                                      {% endif %}
                                  </li>
                              {% endfor %}
                          </ul>
                      </div>
                  </li>
              </ul>
          {% endfor %}
      </div>
  {% endif %}
    {% if currentActivities|length > 0 %}

        <div id="current" class="col s12">
            <div class="c-align p-tb-10">
                <i class="fa fa-2x fa-hourglass-2 activity-status"></i><h4>{% trans %}activities.current_title{% endtrans %}</h4>
            </div>
            {% for currentActivity in currentActivities %}

              {# activity computed constants : are criteria mixed ? is grading exceeding deadlines ? #}

              {% set activityMixed = false %}
              {% set activityType = currentActivity.stages.first.criteria|length > 0 ? currentActivity.stages.first.criteria[0].type  : null %}
              {% set diffGradingDays = null %}
              {% set diffStageDays = -1 %}
              {% for stage in currentActivity.stages if not activityMixed %}

                  {% set diffStageDateInterval = stage.genddate.diff(date(now)) %}

                  {% set diffGradingDays = diffStageDateInterval.days %}
                  {% if stage.genddate|date("Y/m/d") < now %}
                      {% set diffGradingDays = -diffGradingDays %}
                  {% endif %}

                  {% if diffGradingDays > diffStageDays %}
                      {% set diffStageDays = diffGradingDays %}
                  {% endif %}

                  {% for criterion in stage.criteria if not activityMixed %}
                      {% if criterion.type != activityType %}
                          {% set activityMixed = true %}
                      {% endif %}
                  {% endfor %}
              {% endfor %}


                <ul id="activityList{{ currentActivity.id }}" class="collapsible expandMore expandLess" data-collapsible="accordion">
                    <li>
                        <div class="collapsible-header flex-center{% if currentActivities|length == 1 %} active{% endif %} cyan lighten-5">
                            <i class="fa fa-fw fa-chevron-down"></i>
                            <i class="fa fa-fw fa-chevron-right"></i>

                            <div class="activity-banner">
                                <div class="activity-title"> {{ currentActivity.name }} {% if currentActivity.recurring %}<i class="far fa-2x fa-circle-notch fa-recurring tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.recurring{% endtrans %}" data-delay="50" style="margin-left:10px;"></i>{% endif %}</div>
                                {#<div class="activity-description"> {{ currentActivity.objectives }}</div>#}
                            </div>

                            <div style="margin-left:auto;">
                                <ul style="display:flex;align-items:center;">

                                    <li>
                                        <ul style="display: flex;align-items: center;flex-direction:column-reverse; margin-right:5px;" class="tooltipped" data-position="top" data-tooltip="{% if diffStageDays is defined %}{% if diffStageDays >= 0 %}{% trans %}tooltip.activity.grading_deadline.start_msg{% endtrans %} {{ diffStageDays }} {% trans %}tooltip.activity.grading_deadline.end_msg{% endtrans %}{% else %}{% trans %}tooltip.activity.grading_deadline.expired{% endtrans %}{% endif %}{% endif %}">
                                            {% if diffStageDays >= 0 %}<li>{{ diffStageDays }}</li>{% endif %}
                                            <li><i class="far fa-2x fa-clock {% if diffStageDays < 0 %}red-text{% endif %}" style="margin:0!important;"></i></li>
                                        </ul>
                                    </li>

                                    {% set activityProgress = 0 %}
                                    {% set nbFinalizedStages = 0 %}
                                    {% set gradingMode = currentActivity.stages.first.mode %}
                                    {% for stage in currentActivity.stages %}
                                        {% set activityProgress = activityProgress + stage.gradingProgress * 100 %}
                                        {% if stage.mode != gradingMode %}
                                            {% set gradingMode = 2 %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if currentActivity.stages|length > 0 %}
                                        {% set activityProgress = activityProgress / currentActivity.stages|length %}
                                    {% endif %}
                                        <ul style="display:flex;flex-direction: column";>
                                            <ul style="display:flex;flex-direction: row;align-items: center;margin: 0;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.activity_progress{% endtrans %}: {{ min(100, (100 * date(currentActivity.startdate).diff(date(now)).days / max(1, date(currentActivity.startdate).diff(date(currentActivity.enddate)).days))|round(0)) }} %" data-delay="50">
                                                <li><i class="far fa-calendar-alt" style="margin: 0;font-size: 1.3rem"></i></li>
                                                <li class="progress" style="width:30px;margin:0px 10px 0px 0px;background-color:#b7bbbb;">
                                                    <div class="determinate"
                                                        style="width: {{ min(100, (100 * date(currentActivity.startdate).diff(date(now)).days / max(1,date(currentActivity.startdate).diff(date(currentActivity.enddate)).days))|round(0)) }}%;background-color: black;"></div>
                                                </li>
                                            </ul>
                                            <ul style="display:flex;flex-direction: row;align-items: center" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.grading_progress{% endtrans %}: {{ activityProgress|round(0) }} %" data-delay="50">
                                                <li><i class="fa fa-pencil-alt" style="margin: 0;font-size: 1.3rem"></i></li>
                                                <li class="progress" style="width:30px;margin:0px 10px 0px 0px;background-color:#b7bbbb;">
                                                    <div class="determinate"
                                                        style="width: {{ activityProgress|round(0) }}%;background-color: black;"></div>
                                                </li>
                                            </ul>
                                        </ul>
                                        {% if gradingMode == 0 %}
                                            <li><i class="fa fa-2x fa-cube tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.contrib{% endtrans %}" data-delay="50"></i></li>
                                        {% elseif gradingMode == 1 %}
                                            <li><i class="fa fa-2x fa-user tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.contrib{% endtrans %}" data-delay="50"></i></li>
                                        {% else %}
                                            <ul style="display:flex;flex-direction: column";>
                                                <li><i class="fa fa-2x fa-user tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.contrib{% endtrans %}" data-delay="50"></i></li>
                                                <li><i class="fa fa-2x fa-cubes tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.contrib{% endtrans %}" data-delay="50"></i></li>
                                            </ul>
                                        {% endif %}


                                    {#
                                    {% if activityMixed %}
                                        <li><i class="fa fa-2x fa-map-signs tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.mixed{% endtrans %}" data-delay="50"></i></li>
                                    {% else %}
                                        {% if activityType is defined %}
                                            {% if activityType == 0 %}
                                                <li><i class="fa fa-2x fa-pie-chart tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.contrib{% endtrans %}" data-delay="50"></i></li>
                                            {% elseif activityType == 1 %}
                                                <li><i class="fas fa-2x fa-tachometer-alt tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.eval{% endtrans %}" data-delay="50"></i></li>
                                            {% elseif activityType == 2 %}
                                                <li><i class="fas fa-2x fa-comment-dots tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.pureFeedback{% endtrans %}" data-delay="50"></i></li>
                                            {% endif %}
                                        {% else %}
                                            <li></li>
                                        {% endif %}
                                    {% endif %}
                                    #}
                                    <li class="flex-center tooltipped" style="background-color: purple;color: white;width: 23px; height: 23px; border-radius: 100%;justify-content:center" data-position="top" data-tooltip="{% trans %}tooltip.activity.magnitude{% endtrans %}" data-delay="50">
                                        <span>{{currentActivity.magnitude}}</span>
                                    </li>
                                    {% if currentActivity.finalized is null %}
                                            <li><i class="material-icons tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.not_finalized{% endtrans %}" data-delay="50">pause_circle_outline</i></li>
                                    {% endif %}
                                    {# in case there is a user grading an activity belongs to another firm (external to this activity), do not apply for root user #}
                                    {% if currentActivity.organization.id != currentuser.orgId and currentuser.role != 4 %}
                                            <li>
                                                <i class="material-icons green-text tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.external{% endtrans %}" data-delay="50">call_made</i>
                                            </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>

                        <div class="collapsible-body">
                            <div class="collapse" id="details">
                                <ul class="flex-center row" style="justify-content: space-between;">
                                    <li><h4 class="department-name no-margin">{% trans %}activities.details{% endtrans %}</h4></li>
                                    {# Suppress element is only possible : if activity is not requested/attributed/, user is not a collaborator and stage has not been fully graded or if user has root privileges #}
                                    {% if currentActivity.deletable %}
                                        <li style="margin-left:auto;"><a href="#deleteAModal" class="waves-effect waves-light red accent-4 btn white-text modal-trigger" data-aid="{{ currentActivity.id }}">{% trans %}activities.delete_activity_btn{% endtrans %}</a></li>
                                    {% endif %}
                                </ul>
                            </div>
                            <ul class="collection">

                                {% set activityHasResults = false %}
                                {% set nbReleasedStages = 0 %}
                                {% set nbUnreleasedStages = 0 %}
                                {% for stage in currentActivity.stages %}

                                    {% set releasedStage = false %}
                                    {% set selectedTeam = null %}

                                    <li class="collection-item">

                                        {# display is different whether the activity is a requested one or not #}

                                        {% if currentActivity.stages|length > 1 %}
                                            <ul class="flex-center row" style="justify-content: space-between;">
                                                <li><h4 class="department-name no-margin">{{ stage.name }}</h4></li>
                                                {% if stage.modifiable and currentuser.role != 3 %}
                                                    <li style="margin-left:auto;"><a href="#deleteASModal" class="waves-effect waves-light red accent-4 btn white-text modal-trigger" data-sid="{{ stage.id }}">{% trans %}activities.delete_stage_btn{% endtrans %}</a></li>
                                                {% endif %}
                                            </ul>

                                        {% endif %}
                                        <div class="row">
                                            <div class="col s6 m4">
                                                <i class="fa fa-cube" aria-hidden="true"></i> {% trans %}activities.criteria{% endtrans %}
                                            </div>
                                            <div class="col s6 m8">
                                                <ul class="flex-center">
                                                {% for criterion in stage.criteria %}
                                                    <li>
                                                        {% set icon = criterion.cName.icon %}
                                                        {% set iconHtml = '' %}
                                                        {% set iconClass = 'fa fa-cube' %}

                                                        {% if icon is not null %}
                                                            {% if icon.type != 'm' %}
                                                                {% set iconClass = 'fa fa-' ~ icon.name %}
                                                            {% else %}
                                                                {% set iconClass = 'material-icons' %}
                                                                {% set iconHtml = icon.name %}
                                                            {% endif %}
                                                        {% endif %}

                                                        <i  class="{{ iconClass }} tooltipped"
                                                            data-position="top"
                                                            data-tooltip="{{ criterion.cName.name }}"
                                                            style="font-size: 1.3rem !important; margin-right: 10px;">{{ iconHtml }}</i>
                                                    </li>
                                                {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col s6 m4">
                                                <i class="far fa-clock" aria-hidden="true"></i> {% trans %}activities.activity_period{% endtrans %}
                                            </div>
                                            <div class="col s6 m4 desktop-dates">{{ stage.startdate|localizeddate('long', 'none') }} - {{ stage.enddate|localizeddate('long', 'none') }}</div>
                                            <div class="col s6 m4 mobile-dates">{{ stage.startdate|localizeddate('short', 'none', null, null, 'dd/MM') }} - {{ stage.enddate|localizeddate('short', 'none', null, null, 'dd/MM') }}</div>
                                        </div>

                                        <div class="row">
                                            <div class="col s6 m4">
                                                <i class="far fa-clock" aria-hidden="true"></i> {% trans %}activities.grading_period{% endtrans %}
                                            </div>
                                            <div class="col s6 m4 desktop-dates">{{ stage.gstartdate|localizeddate('long', 'none') }} - {{ stage.genddate|localizeddate('long', 'none') }}</div>
                                            <div class="col s6 m4 mobile-dates">{{ stage.gstartdate|localizeddate('short', 'none', null, null, 'dd/MM') }} - {{ stage.genddate|localizeddate('short', 'none', null, null, 'dd/MM') }}</div>
                                        </div>

                                        <div class="row">
                                            <div class="col s12 m4">
                                                <i class="fa fa-tasks" aria-hidden="true"></i> {% trans %}activities.progress{% endtrans %}
                                            </div>
                                            <div class="col s9 m4">
                                                <div class="progress">
                                                    <div class="determinate" style="width: {{ stage.gradingProgress * 100 }}%"></div>
                                                </div>
                                            </div>
                                            <div class="col s3 m3">
                                                {{ (stage.gradingProgress * 100)|round(0) }}%
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col s10 m4">
                                                <i class="fa fa-users" aria-hidden="true"></i>{% trans %}activities.participants{% endtrans %}
                                            </div>
                                            <div class="col s2 m4">
                                                    {% if stage.uniqueParticipations|length != stage.distinctParticipations|length %}
                                                        {{ stage.uniqueParticipations|length }} ({{ stage.distinctParticipations|length }})
                                                    {% else %}
                                                        {{ stage.distinctParticipations|length }}
                                                    {% endif %}
                                            </div>
                                        </div>

                                        <div class="row no-margin">
                                          <ul class="participants">
                                              {% set allMembersHaveValidatedGrades = null %}
                                              {% for pkey, participant in stage.uniqueParticipations %}

                                                    {% set user = participant.user(app) %}
                                                    {% set isExternal = false %}
                                                    {% set extUser = null %}


                                                    {% if currentuser.orgId != user.orgId %}
                                                        {% set isExternal = true %}
                                                        {% set break = false %}
                                                        {% for externalUser in user.externalUsers if not break %}
                                                            {% if externalUser.client.clientOrganization.id == currentuser.orgId %}
                                                                {% set break = true %}
                                                                {% set extUser = externalUser %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endif %}

                                                  {% if participant.team is null %}
                                                      <li class="participant" style="position: relative">
                                                          <ul class="flex-center" style="flex-direction: column">
                                                              <li>
                                                                  <div class="picture-frame">
                                                                    <img class="user-picture {{ not isExternal ?'tooltipped' }}" src="{{ (user.picture is not null) ? asset('lib/img/' ~ user.picture) : asset('lib/img/no-picture.png') }}" data-position="top" data-tooltip="{{ not isExternal ? user.fullname}}" data-delay="50" alt="">
                                                                  </div>
                                                              </li>
                                                              <li>
                                                                  <div class="participant-name">
                                                                        <span>
                                                                            {% if isExternal == true and extUser is not null %}
                                                                                {% if extUser.firstname != null %}
                                                                                    {{ extUser.firstname }}
                                                                                    {% if extUser.deleted != null %}
                                                                                        <span style="color: black;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.deleted_user{% endtrans %}" data-delay="50">†</span>
                                                                                    {% endif %}
                                                                                {% else %}
                                                                                    {{ user.organization(app).commname }}
                                                                                {% endif %}
                                                                            {% else %}
                                                                                {% if user.deleted != null %}
                                                                                        <span style="color: black;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.deleted_user{% endtrans %}" data-delay="50">†</span>
                                                                                {% endif %}
                                                                                {{ stage.uniqueParticipantNames[pkey] }}
                                                                            {% endif %}
                                                                        </span>
                                                                        {% if isExternal == true and extUser is not null %}
                                                                            <span style="background-color: #26A69A;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.external_user_msg{% endtrans %}" data-delay="50">E</span>
                                                                        {% endif %}
                                                                        {% if participant.type == 0 %}
                                                                            <span style="background-color: purple;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.tp_participant_msg{% endtrans %}" data-delay="50">T</span>
                                                                        {% elseif participant.type == -1 %}
                                                                            <span style="background-color: orange;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.passive_participant_msg{% endtrans %}" data-delay="50">P</span>
                                                                        {% endif %}
                                                                        {% if participant.precomment is not null and participant.precomment != "" %}
                                                                            <i class="fa fa-flag tooltipped" data-position="top" data-tooltip="{{ participant.precomment }}" data-delay="50" style="color:#15a6ae;" title="{% trans %}grade.precomment.button_existing_title{% endtrans %}"></i>
                                                                        {% endif %}
                                                                        {% if participant.status == 3 and stage.status < 2 %}
                                                                            <span class="material-icons green-text tooltipped" style="font-size:16px" data-position="top" data-tooltip="{% trans %}tooltip.activity.validated_grades{% endtrans %}" data-delay="50">check_circle</span>
                                                                        {% endif %}
                                                                        {% if participant.leader %}
                                                                            <i class="fa fa-star tooltipped" style="font-size:16px" data-position="top" data-tooltip="{% trans %}participants.leader{% endtrans %}" data-delay="50"></i>
                                                                        {% endif %}
                                                                  </div>
                                                              </li>
                                                          </ul>
                                                      </li>
                                                    {% else %}
                                                        {% if selectedTeam is null or selectedTeam != participant.team %}

                                                            {% if stage.status < 2 and allMembersHaveValidatedGrades == null %}

                                                                {% set break = false %}
                                                                {% for teamParticipant in stage.distinctParticipations if not break %}
                                                                    {% if teamParticipant.team is not null and teamParticipant.status < 3 %}
                                                                        {% set break = true %}
                                                                        {% set allMembersHaveValidatedGrades = false %}
                                                                    {% endif %}
                                                                {% endfor %}
                                                                {% if break == false %}
                                                                    {% set allMembersHaveValidatedGrades = true %}
                                                                {% endif %}

                                                            {% endif %}

                                                          <li class="participant" style="position: relative">
                                                                <ul class="flex-center" style="flex-direction: column">
                                                                    <li>
                                                                        {% if participant.team.picture != "" and participant.team.picture is not null %}
                                                                        <div class="picture-frame">
                                                                            <img class="user-picture" src="{{ participant.team.picture }}" alt="">
                                                                        </div>
                                                                        {% else %}
                                                                            <div class="picture-frame flex-center" style="background-color: #b3b3b3; border-radius: 100%; height: 50px; justify-content: center">
                                                                                <i class="fa fa-users" style="color: white; font-size: 2rem; margin: 0px;"></i>
                                                                            </div>
                                                                        {% endif %}
                                                                    </li>
                                                                    <li>
                                                                        <div class="participant-name">
                                                                            <span>{{ participant.team.name }}</span>
                                                                            {% if participant.type == 0 %}
                                                                                <span style="background-color: purple;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.tp_participant_msg{% endtrans %}" data-delay="50">T</span>
                                                                            {% elseif participant.type == -1 %}
                                                                                <span style="background-color: orange;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.passive_participant_msg{% endtrans %}" data-delay="50">P</span>
                                                                            {% endif %}
                                                                            {% if participant.precomment is not null and participant.precomment != "" %}
                                                                                <i class="fa fa-flag tooltipped" data-position="top" data-tooltip="{{ participant.precomment }}" data-delay="50" style="color:#15a6ae;" title="{% trans %}grade.precomment.button_existing_title{% endtrans %}"></i>
                                                                            {% endif %}
                                                                            {% if allMembersHaveValidatedGrades == true %}
                                                                                <i class="material-icons green-text tooltipped" style="font-size:16px" data-position="top" data-tooltip="{% trans %}tooltip.activity.validated_grades{% endtrans %}" data-delay="50">check_circle</i>
                                                                            {% endif %}
                                                                            {% if participant.leader %}
                                                                                <i class="fa fa-star tooltipped" style="font-size:16px" data-position="top" data-tooltip="{% trans %}participants.leader{% endtrans %}" data-delay="50"></i>
                                                                            {% endif %}
                                                                        </div>
                                                                    </li>
                                                                </ul>
                                                          </li>
                                                      {% endif %}
                                                  {% endif %}
                                              {% endfor %}
                                          </ul>
                                        </div>
                                        <br>
                                        <div class="row action-buttons">

                                            {% if stage.modifiable %}
                                                    <div class="button-field">
                                                        <a class="btn-large waves-effect waves-light teal lighten-1 modify-btn" href="{{ url('manageActivityElement',{'elmtType' : 'activity', 'elmtId' : currentActivity.id}) }}"> {% trans %}activities.modify{% endtrans %} </a>
                                                    </div>
                                            {% endif %}
                                            {# Grade or see results button #}
                                            {#{% if stage.status < 2 or stage.status == 2 and currentuser.role in [ 2, 3 ] %}#}
                                              {% set break = false %}
                                              {% for participant in stage.participants if not break %}
                                                    {% if participant.usrId == currentuser.id and participant.type != -1 and now >= stage.gstartdate|date("Y/m/d") %}
                                                      {% if participant.status == 3 or participant.status < 3 and now <= stage.genddate|date("Y/m/d") %}
                                                              <div class="button-field">
                                                                  <a class="btn-large waves-effect waves-light teal lighten-1 grade-btn" href="{{ url('newStageGrade',{'stgId' : stage.id})}}"> {% if participant.status == 3 %}{% trans %} activities.see_grades {% endtrans %}{% elseif participant.status == 2 or participant.status == 1 %}{% trans %} activities.finalize_grades {% endtrans %}{% else %}{% trans %}activities.grade{% endtrans %}{% endif %} </a>
                                                              </div>
                                                      {% endif %}
                                                      {% set break = true %}
                                                  {% endif %}
                                              {% endfor %}
                                          {#{% endif %}#}

                                            {# If no org option, we determine if current user is stage leader AND AM to grant him access or not to results button #}
                                            {% set isUserAMLeader = false %}
                                            {% if not existingAccessAndResultsViewOption and currentuser.role in [2]  %}
                                                {% set break = false %}
                                                {% for participant in stage.participants if not break %}
                                                    {% if participant.leader and participant.usrId == currentuser.id and currentuser.role == 2 %}
                                                        {% set break = true %}
                                                        {% set isUserAMLeader = true %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}

                                            {# Results visible if : 1/ user is root, and results are at least computed, or 2/ if option exists, if stage is not hidden and user has relevant status access, 3/ otherwise a/ if released : visible to any role (normal as if displayed it means user is participating), b/ if only computed, visible to any administrator, or AM leader  #}
                                            {% set hasResultsAccess = (currentuser.role == 4 and stage.status >= 2)
                                                or existingAccessAndResultsViewOption and stage not in hideResultsFromStageIds and stage.status >= statusAccess
                                                or not existingAccessAndResultsViewOption and stage.status == 3 or stage.status >= 2 and (currentuser.role == 1 or isUserAMLeader)
                                            %}


                                            {% if hasResultsAccess %}
                                                <div class="button-field">
                                                    <a class="btn-large waves-effect waves-light blue darken-4 results-btn" href="{{ url('activityResults',{'actId' : stage.activity.id}) }}" style="color: white;"> {% trans %}activities.results{% endtrans %}</a>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </li>
                </ul>
            {% endfor %}
        </div>
    {% endif %}
  {% if completedAndReleasedActivities|length > 0 %}

      <div id="completed" class="col s12">
          <div class="c-align p-tb-10">
              <i class="fa fa-2x fa-hourglass-3 activity-status"></i><h4>{% trans %}activities.completed_title{% endtrans %}</h4>
          </div>
          {% for completedAndReleasedActivity in completedAndReleasedActivities %}

              {% set activityMixed = false %}
              {% set activityType = completedAndReleasedActivity.stages[0].criteria[0].type %}
              {% set diffGradingDays = null %}
              {% set diffStageDays = -1 %}
              {% set oldestStageStartDate = completedAndReleasedActivity.stages[0].startdate|date("Y/m/d") %}
              {% set newestStageEndDate = completedAndReleasedActivity.stages[0].enddate|date("Y/m/d") %}
              {% for stage in completedAndReleasedActivity.stages if not activityMixed %}

                  {% set diffStageDateInterval = stage.genddate.diff(date(now)) %}

                  {% set diffGradingDays = diffStageDateInterval.days %}
                  {% if stage.genddate|date("Y/m/d") < now %}
                      {% set diffGradingDays = -diffGradingDays %}
                  {% endif %}

                  {% if stage.startdate|date("Y/m/d") < oldestStageStartDate %}
                      {% set oldestStageStartDate = stage.startdate|date("Y/m/d") %}
                  {% endif %}
                  {% if stage.enddate|date("Y/m/d") < newestStageEndDate %}
                      {% set newestStageEndDate = stage.enddate|date("Y/m/d") %}
                  {% endif %}


                  {% if diffGradingDays > diffStageDays %}
                      {% set diffStageDays = diffGradingDays %}
                  {% endif %}
                  {% for criterion in stage.criteria if not activityMixed %}
                      {% if criterion.type != activityType %}
                          {% set activityMixed = true %}
                      {% endif %}
                  {% endfor %}
              {% endfor %}

              <ul id="activityList{{ completedAndReleasedActivity.id }}" class="collapsible expandMore expandLess" data-collapsible="accordion">
                  <li>
                      <div class="collapsible-header flex-center{% if completedAndReleasedActivities|length == 1 %} active{% endif %} orange lighten-5">
                          <i class="fa fa-fw fa-chevron-down"></i>
                          <i class="fa fa-fw fa-chevron-right"></i>
                          <div class="activity-banner">
                              <div class="activity-title"> {{ completedAndReleasedActivity.name }} {% if completedAndReleasedActivity.recurring %}<i class="far fa-2x fa-circle-notch fa-recurring tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.recurring{% endtrans %}" data-delay="50" style="margin-left:10px;"></i>{% endif %}</div>
                              {#<div class="activity-description"> {{ completedAndReleasedActivity.objectives  }}</div>#}
                          </div>

                          <div style="margin-left:auto;">
                              <ul style="display:flex;align-items:center;">
                                  {% if completedAndReleasedActivity.status == 3 %}
                                      <li>
                                          <i class="material-icons green-text tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.released{% endtrans %}" data-delay="50">check_circle</i>
                                      </li>
                                  {% endif %}
                                  {% if activityMixed %}
                                      <li><i class="fa fa-2x fa-map-signs tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.mixed{% endtrans %}" data-delay="50"></i></li>
                                  {% else %}

                                      {% if activityType is defined %}
                                          {% if activityType == 0 %}
                                              <li><i class="fa fa-2x fa-pie-chart tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.contrib{% endtrans %}" data-delay="50"></i></li>
                                          {% elseif activityType == 1 %}
                                              <li><i class="fas fa-2x fa-tachometer-alt tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.eval{% endtrans %}" data-delay="50"></i></li>
                                          {% elseif activityType == 2 %}
                                              <li><i class="fas fa-2x fa-comment-dots tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.pureFeedback{% endtrans %}" data-delay="50"></i></li>
                                          {% elseif activityType == 3 %}
                                              <li><i class="fas fa-2x fa-toggle-on tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.binary{% endtrans %}" data-delay="50"></i></li>
                                          {% endif %}
                                      {% endif %}
                                      <li class="flex-center tooltipped" style="background-color: purple;color: white;width: 23px; height: 23px; border-radius: 100%; justify-content:center" data-position="top" data-tooltip="{% trans %}tooltip.activity.magnitude{% endtrans %}" data-delay="50">
                                        <span>{{completedAndReleasedActivity.magnitude}}</span>
                                      </li>
                                      {# in case there is a user grading an activity belongs to another firm (external to this activity), do not apply for root user #}
                                      {% if completedAndReleasedActivity.organization.id != currentuser.orgId and currentuser.role != 4 %}
                                          <li>
                                              <i class="material-icons green-text tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.external{% endtrans %}" data-delay="50">call_made</i>
                                          </li>
                                      {% endif %}

                                  {% endif %}
                              </ul>
                          </div>
                      </div>

                      <div class="collapsible-body">
                          <div class="collapse" id="details">
                              <ul class="flex-center row" style="justify-content: space-between;">
                                  <li><h4 class="department-name no-margin">{% trans %}activities.details{% endtrans %}</h4></li>
                                   {% if completedAndReleasedActivity.deletable %}
                                      <li style="margin-left:auto;"><a href="#deleteAModal" class="waves-effect waves-light red accent-4 btn white-text modal-trigger" data-aid="{{ completedAndReleasedActivity.id }}">{% trans %}activities.delete_activity_btn{% endtrans %}</a></li>
                                   {% endif %}
                              </ul>
                          </div>
                          <ul class="collection">

                              {% set activityHasResults = false %}
                              {% set nbParticipatingReleases = 0 %}
                              {% set nbReleasedStages = 0 %}
                              {% set nbUnreleasedStages = 0 %}

                              {% set hiddenActivityResults = true %}
                              {% set break = false %}
                              {% for stage in completedAndReleasedActivity.stages if not break %}
                                    {% if stage.id not in hideResultsFromStageIds %}
                                        {% set hiddenActivityResults = false %}
                                        {% set break = true %}
                                    {% endif %}
                              {% endfor %}

                              {% for stage in completedAndReleasedActivity.stages %}

                                  {% set releasedStage = false %}
                                  {% set selectedTeam = null %}

                                  <li class="collection-item">

                                      {% if completedAndReleasedActivity.stages|length > 1 %}
                                          <ul class="flex-center row" style="justify-content: space-between;">
                                              <li><h4 class="department-name no-margin">{{ stage.name }}</h4></li>
                                          </ul>
                                      {% endif %}
                                        <div class="row">
                                            <div class="col s6 m4">
                                                <i class="fa fa-cube" aria-hidden="true"></i> {% trans %}activities.criteria{% endtrans %}
                                            </div>
                                            <div class="col s6 m8">
                                                <ul class="flex-center">
                                                    {% for criterion in stage.criteria %}
                                                        <li>
                                                            {% set icon = criterion.cName.icon %}
                                                            {% set iconHtml = '' %}
                                                            {% set iconClass = 'fa fa-cube' %}

                                                            {% if icon is not null %}
                                                                {% if icon.type != 'm' %}
                                                                    {% set iconClass = icon.type ~ ' fa-' ~ icon.name %}
                                                                {% else %}
                                                                    {% set iconClass = 'material-icons' %}
                                                                    {% set iconHtml = icon.name %}
                                                                {% endif %}
                                                            {% endif %}

                                                            <i  class="{{ iconClass }} tooltipped"
                                                                data-position="top"
                                                                data-tooltip="{{ criterion.cName.name }}"
                                                                style="font-size: 1.3rem !important; margin-right: 10px;">{{ iconHtml }}</i>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col s6 m4">
                                                <i class="far fa-clock" aria-hidden="true"></i> {% trans %}activities.activity_period{% endtrans %}
                                            </div>
                                            <div class="col s6 m4 desktop-dates">{{ stage.startdate|localizeddate('long', 'none') }} - {{ stage.enddate|localizeddate('long', 'none') }}</div>
                                            <div class="col s6 m4 mobile-dates">{{ stage.startdate|localizeddate('short', 'none', null, null, 'dd/MM') }} - {{ stage.enddate|localizeddate('short', 'none', null, null, 'dd/MM') }}</div>
                                        </div>

                                        <div class="row">
                                            <div class="col s6 m4">
                                                <i class="far fa-clock" aria-hidden="true"></i> {% trans %}activities.grading_period{% endtrans %}
                                            </div>
                                            <div class="col s6 m4 desktop-dates">{{ stage.gstartdate|localizeddate('long', 'none') }} - {{ stage.genddate|localizeddate('long', 'none') }}</div>
                                            <div class="col s6 m4 mobile-dates">{{ stage.gstartdate|localizeddate('short', 'none', null, null, 'dd/MM') }} - {{ stage.genddate|localizeddate('short', 'none', null, null, 'dd/MM') }}</div>
                                        </div>

                                        <div class="row">
                                            <div class="col s10 m4">
                                                <i class="fa fa-users" aria-hidden="true"></i>{% trans %}activities.participants{% endtrans %}
                                            </div>
                                            <div class="col s2 m4">
                                                {{ stage.distinctParticipations|length }}
                                            </div>
                                        </div>

                                      <div class="row no-margin">
                                          <ul class="participants">
                                              {% for pkey, participant in stage.distinctParticipations %}

                                                    {% set user = participant.user(app) %}
                                                    {% set isParticipantExternal = false %}
                                                    {% set extUser = null %}
                                                    {% set isCurrentUserExternal = false %}


                                                    {% if currentuser.orgId != user.orgId %}
                                                        {% set isParticipantExternal = true %}

                                                        {% if stage.activity.organization.id == currentuser.orgId %}
                                                            {% set isCurrentUserExternal = true %}
                                                        {% endif %}

                                                        {% set break = false %}
                                                        {% for externalUser in user.externalUsers if not break %}
                                                            {% if externalUser.client.clientOrganization.id == currentuser.orgId %}
                                                                {% set break = true %}
                                                                {% set extUser = externalUser %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endif %}



                                                  {% if participant.team is null %}
                                                      <li class="participant" style="position: relative">
                                                          <ul class="flex-center" style="flex-direction: column">
                                                              <li>
                                                                  <div class="picture-frame">
                                                                      <img class="user-picture {{ not isParticipantExternal ?'tooltipped' }}" src="{{ (user.picture is not null) ? asset('lib/img/' ~ user.picture) : asset('lib/img/no-picture.png') }}" data-position="top" data-tooltip="{{ not isParticipantExternal ? user.fullname}}" data-delay="50" alt="">
                                                                  </div>
                                                              </li>
                                                              <li>
                                                                  <div class="participant-name">
                                                                        <span>
                                                                            {% if isParticipantExternal == true and extUser is not null %}
                                                                                {% if isCurrentUserExternal == true %}
                                                                                    {% if extUser.firstname != null %}
                                                                                        {{ extUser.firstname }}
                                                                                        {% if extUser.deleted != null %}
                                                                                            <span style="color: black;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.deleted_user{% endtrans %}" data-delay="50">†</span>
                                                                                        {% endif %}
                                                                                    {% else %}
                                                                                        {{ user.organization(app).commname }}
                                                                                    {% endif %}
                                                                                {% else %}
                                                                                    {{ user.organization(app).commname }}
                                                                                {% endif %}
                                                                            {% else %}
                                                                                {% if user.deleted != null %}
                                                                                        <span style="color: black;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.deleted_user{% endtrans %}" data-delay="50">†</span>
                                                                                {% endif %}
                                                                                    {{ stage.uniqueParticipantNames[pkey] }}
                                                                            {% endif %}
                                                                        </span>
                                                                        {% if isCurrentUserExternal == true and extUser is not null %}
                                                                            <span style="background-color: #26A69A;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.external_user_msg{% endtrans %}" data-delay="50">E</span>
                                                                        {% endif %}
                                                                        {% if participant.type == 0 %}
                                                                            <span style="background-color: purple;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.tp_participant_msg{% endtrans %}" data-delay="50">T</span>
                                                                        {% elseif participant.type == -1 %}
                                                                            <span style="background-color: orange;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.passive_participant_msg{% endtrans %}" data-delay="50">P</span>
                                                                        {% endif %}
                                                                        {% if participant.precomment is not null and participant.precomment != "" %}
                                                                            <i class="fa fa-flag tooltipped" data-position="top" data-tooltip="{{ participant.precomment }}" data-delay="50" style="color:#15a6ae;" title="{% trans %}grade.precomment.button_existing_title{% endtrans %}"></i>
                                                                        {% endif %}
                                                                        {% if participant.leader %}
                                                                            <i class="fa fa-star tooltipped" style="font-size:16px" data-position="top" data-tooltip="{% trans %}participants.leader{% endtrans %}" data-delay="50"></i>
                                                                        {% endif %}
                                                                  </div>
                                                              </li>
                                                          </ul>
                                                      </li>
                                                  {% else %}
                                                      {% if selectedTeam is null or selectedTeam != participant.team %}
                                                           <li class="participant" style="position: relative">
                                                                <ul class="flex-center" style="flex-direction: column">
                                                                    <li>
                                                                        {% if participant.team.picture != "" and participant.team.picture is not null %}
                                                                        <div class="picture-frame">
                                                                            <img class="user-picture" src="{{ participant.team.picture }}" alt="">
                                                                        </div>
                                                                        {% else %}
                                                                            <div class="picture-frame flex-center" style="background-color: #b3b3b3; border-radius: 100%; height: 50px; justify-content: center">
                                                                                <i class="fa fa-users" style="color: white; font-size: 2rem; margin: 0px;"></i>
                                                                            </div>
                                                                        {% endif %}
                                                                    </li>
                                                                    <li>
                                                                        <div class="participant-name">
                                                                            <span>{{ participant.team.name }}</span>
                                                                            {% if participant.type == 0 %}
                                                                                <span style="background-color: purple;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.tp_participant_msg{% endtrans %}" data-delay="50">T</span>
                                                                            {% elseif participant.type == -1 %}
                                                                                <span style="background-color: orange;color: white;padding: 0px 5px;border-radius: 100%;" class="tooltipped" data-position="top" data-tooltip="{% trans %}tooltip.activity.passive_participant_msg{% endtrans %}" data-delay="50">P</span>
                                                                            {% endif %}
                                                                            {% if participant.precomment is not null and participant.precomment != "" %}
                                                                                <i class="fa fa-flag tooltipped" data-position="top" data-tooltip="{{ participant.precomment }}" data-delay="50" style="color:#15a6ae;" title="{% trans %}grade.precomment.button_existing_title{% endtrans %}"></i>
                                                                            {% endif %}
                                                                            {% if participant.leader %}
                                                                                <i class="fa fa-star tooltipped" style="font-size:16px" data-position="top" data-tooltip="{% trans %}participants.leader{% endtrans %}" data-delay="50"></i>
                                                                            {% endif %}
                                                                        </div>
                                                                    </li>
                                                                </ul>
                                                          </li>
                                                          {% set selectedTeam = participant.team %}
                                                      {% endif %}
                                                {% endif %}
                                              {% endfor %}
                                          </ul>
                                      </div>
                                      <br>

                                      <div class="row action-buttons">

                                            {#{% if currentuser.role in [ 2, 3 ] %}#}
                                            {% set break = false %}
                                                {% for participant in stage.participants if not break %}
                                                    {% if participant.usrId == currentuser.id and participant.type != -1 and now >= stage.gstartdate|date("Y/m/d") %}
                                                        {% if participant.status == 3 %}
                                                            <div class="button-field">
                                                                <a class="btn-large waves-effect waves-light teal lighten-1 grade-btn" href="{{ url('newStageGrade',{'stgId' : stage.id})}}"> {% trans %} activities.see_grades {% endtrans %}</a>
                                                            </div>
                                                        {% endif %}
                                                        {% set break = true %}
                                                    {% endif %}
                                                {% endfor %}
                                            {#{% endif %}#}



                                            {% if not hiddenActivityResults %}

                                                {# If no org option, we determine if current user is stage leader AND AM to grant him access or not to results button #}
                                                {% set isUserAMLeader = false %}
                                                {% if not existingAccessAndResultsViewOption and currentuser.role in [2]  %}
                                                    {% set break = false %}
                                                    {% for participant in stage.participants if not break %}
                                                        {% if participant.leader and participant.usrId == currentuser.id and currentuser.role == 2 %}
                                                            {% set break = true %}
                                                            {% set isUserAMLeader = true %}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}

                                                {# Results visible if : 1/ user is root, and results are at least computed, or 2/ if option exists, if stage is not hidden and user has relevant status access, 3/ otherwise a/ if released : visible to any role (normal as if displayed it means user is participating), b/ if only computed, visible to any administrator, or AM leader  #}
                                                {% set hasResultsAccess = (currentuser.role == 4 and stage.status >= 2)
                                                    or existingAccessAndResultsViewOption and stage not in hideResultsFromStageIds and stage.status >= statusAccess
                                                    or not existingAccessAndResultsViewOption and stage.status == 3 or stage.status >= 2 and (currentuser.role == 1 or isUserAMLeader)
                                                %}

                                                {% if completedAndReleasedActivity.stages|length == 1 %}

                                                    {# check if user is external to organization which created the activity #}
                                                    {% set hideResultsToExternalUser = false %}
                                                    {% if currentuser.orgId != completedAndReleasedActivity.organization.id %}
                                                        {% set break = false %}
                                                        {% for participant in stage.uniqueParticipations if not break %}
                                                            {% if participant.usrId == currentuser.id %}
                                                                {% if participant.status < 4 %}
                                                                    {% set hideResultsToExternalUser = true %}
                                                                    {% set break = true %}
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endif %}

                                                    {% if hasResultsAccess %}
                                                        <div class="button-field">
                                                            {% if not hideResultsToExternalUser %}
                                                            <a class="btn-large waves-effect waves-light blue darken-4 results-btn" href="{{ url('activityResults',{'actId' : stage.activity.id}) }}" style="color: white;"> {% trans %}activities.results{% endtrans %}</a>
                                                            {% else %}
                                                            <a class="btn-large waves-effect waves-light blue darken-4 results-btn" href="{{ url('requestResults',{'stgId' : stage.id, 'usrId' : currentuser.id}) }}" style="color: white;"> {% trans %}activities.request_results{% endtrans %}</a>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}

                                                {% else %}

                                                    {% if completedAndReleasedActivity.status == 3 %}
                                                        {% if hasResultsAccess and stage == completedAndReleasedActivity.stages|last %}
                                                                <div class="button-field">
                                                                    <a class="btn-large waves-effect waves-light blue darken-4 results-btn" href="{{ url('activityResults',{'actId' : stage.activity.id}) }}" style="color: white;"> {% trans %}activities.results{% endtrans %}</a>
                                                                </div>
                                                        {% endif %}
                                                    {% else %}

                                                        {% set allComputed = true %}
                                                        {% for actStage in completedAndReleasedActivity.stages if allComputed %}
                                                            {% if actStage.status < 2 %}
                                                                {% set allComputed = false %}
                                                            {% endif %}
                                                        {% endfor %}

                                                        {% if hasResultsAccess %}
                                                            {% if stage == completedAndReleasedActivity.stages|last and allComputed %}
                                                                <div class="button-field">
                                                                    <a class="btn-large waves-effect waves-light blue darken-4 results-btn" href="{{ url('activityResults',{'actId' : stage.activity.id}) }}" style="color: white;"> {% trans %}activities.results{% endtrans %}</a>
                                                                </div>
                                                            {% else %}
                                                                <div class="button-field">
                                                                    <a class="btn-large waves-effect waves-light blue darken-4 results-btn" href="{{ url('activityResults',{'actId' : stage.activity.id}) }}" style="color: white;"> {% trans %}activities.results{% endtrans %}</a>
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                  </li>
                              {% endfor %}
                          </ul>
                      </div>
                  </li>
              </ul>
          {% endfor %}
      </div>
    {% endif %}

    {% if discardedActivities|length > 0 %}
        <div id="discardModal" class="modal">
            <div class="modal-content">
                <p>{% trans %}activities.request.discard_msg{% endtrans %}</p>
            </div>
            <div class="modal-footer">
                <a class="modal-action modal-close submit-button waves-effect waves-green btn-large discard-button">{% trans %}activities.request.confirm_btn_msg{% endtrans %}</a>
                <a class="modal-action modal-close waves-effect waves-green btn-flat red-text">{% trans %}activities.request.cancel_btn_msg{% endtrans %}</a>
            </div>
        </div>
    {% endif %}

  {% if user_activities|length == 0 %}
      <div class="container">
          <div class="center">
              <i class="fa fa-clipboard fa-3x"></i>
              <h4>{% trans %}activities.no_activities_title{% endtrans %}</h4>
              <p>{% if currentuser.role == 3 %}{% trans %}activities.no_activities_msg_collaborator{% endtrans %}{% else %}{% trans %}activities.no_activities_msg_activity_manager{% endtrans %}{% endif %}</p>
          </div>
      </div>
  {% endif %}

    {% if currentuser.role !=3 %}
    <div id="fixedButton" class="fixed-action-btn">
        {#<button type="submit" class="waves-effect waves-light btn-large green accent-4">{% trans %}users_list.add_users_button{% endtrans %}</button>#}
        <a class="btn-floating blue darken-2"><i class="material-icons">add</i></a>
        <ul>
            <li><a class="btn-floating orange lighten-2 tooltipped modal-trigger" data-position="left" data-delay="50" data-tooltip="{% trans %}tooltip.template.create_from_scratch{% endtrans %}" href="{{ path('activityInitialisation',{'elmt' : 'template'}) }}">
                <div style="position: relative;display:inline-block">
                    <i class="fa fa-file"></i>
                    <i class="material-icons template-pencil" style="position: absolute; top:5%; left:14%;color:orange">create</i>
                </div>
                </a>
            </li>
            <li><a class="btn-floating tooltipped {% if organization.templateActivities|length == 0 %}grey{% else %} cyan darken-2 modal-trigger" href="#selectTemplate{% endif %}" data-position="left" data-delay="50" data-tooltip="{% trans %}tooltip.activity.create_from_template{% endtrans %}"><i class="material-icons">view_headline</i></a></li>
            <li><a class="btn-floating teal accent-4 tooltipped modal-trigger" data-position="left" data-delay="50" data-tooltip="{% trans %}tooltip.activity.create_from_scratch{% endtrans %}" href="#createActivity"><i class="material-icons">create</i></a></li>
        </ul>
    </div>
    {% endif %}

    {###### MODALS  ######}

      {#{% if is_granted('ROLE_ADMIN') or is_granted('ROLE_ACTIVITY_MANAGER') %}#}
    {% if currentuser.role != 3 %}

          {#<div class="button-field center-button">
              <a class="waves-effect waves-light btn-large green accent-4 modal-trigger" href="#createActivity">{% trans %}activities.create.modal_trg_msg{% endtrans %}</a>
          </div>#}
          <div id="createActivity" class="modal">
              <i class="fa fa-2x fa-window-close modal-close dismiss-modal"></i>
              <div class="modal-content">
                  <h4>{% trans %}activities.create.delegate_choice_title_msg{% endtrans %}</h4>
                  <p>{% trans %}activities.create.delegate_choice_msg{% endtrans %}</p>
              </div>
              <div class="modal-footer action-buttons">
                  <div class="button-field">
                    <a class="waves-effect waves-green btn-large" href="{{ path('activityInitialisation',{'elmt' : 'activity'}) }}">{% trans %}activities.create.nodelegate_btn_msg{% endtrans %}</a>
                  </div>
                  <div class="button-field">
                      <a class="waves-effect waves-green btn-large modal-trigger" href="#delegateActivity">{% trans %}activities.create.delegate_btn_msg{% endtrans %}</a>
                  </div>
              </div>

          </div>
            <div id="deleteAModal" class="modal">
                <div class="modal-content">
                    {#{% if user_activities[k].stages|length > 1 %}#}
                    <p>{% trans %}activities.delete_activity_msg{% endtrans %}</p>
                    {#{% else %}
                        <p>{% trans %}activities.delete_activity_msg{% endtrans %}Are you sure you want to delete this activity ?</p>
                    {% endif %}#}
                </div>
                <div class="modal-footer">
                    <a class=" modal-action modal-close waves-effect waves-green btn-large delete-button">{% trans %}user_update.delete_modal.confirm{% endtrans %}</a>
                    <a class=" modal-action modal-close waves-effect waves-green btn-flat red-text">{% trans %}user_update.delete_modal.decline{% endtrans %}</a>
                </div>
            </div>
          <div id="deleteASModal" class="modal">
              <div class="modal-content">
                  {#{% if user_activities[k].stages|length > 1 %}#}
                      <p>{% trans %}activities.delete_stage_msg{% endtrans %}</p>
                  {#{% else %}
                      <p>{% trans %}activities.delete_activity_msg{% endtrans %}Are you sure you want to delete this activity ?</p>
                  {% endif %}#}
              </div>
              <div class="modal-footer">
                  <a class=" modal-action modal-close waves-effect waves-green btn-large delete-button">{% trans %}user_update.delete_modal.confirm{% endtrans %}</a>
                  <a class=" modal-action modal-close waves-effect waves-green btn-flat red-text">{% trans %}user_update.delete_modal.decline{% endtrans %}</a>
              </div>
          </div>
          <div id="deleteRModal" class="modal">
              <div class="modal-content">
                  {#{% if user_activities[k].stages|length > 1 %}#}
                  <p>{% trans %}activities.delete_recurring_msg{% endtrans %}</p>
                  {#{% else %}
                      <p>{% trans %}activities.delete_activity_msg{% endtrans %}Are you sure you want to delete this activity ?</p>
                  {% endif %}#}
              </div>
              <div class="modal-footer action-buttons" style="justify-content:space-around;align-items:center;">
                  <a class=" modal-action modal-close waves-effect waves-green btn-large rdelete-button">{% trans %}activities.delete_rec_all_confirm{% endtrans %}</a>
                  <a class=" modal-action modal-close waves-effect waves-green btn-large adelete-button">{% trans %}activities.delete_rec_single_confirm{% endtrans %}</a>
                  <a class=" modal-action modal-close waves-effect waves-green btn-flat red-text">{% trans %}activities.delete_cancel{% endtrans %}</a>
              </div>
          </div>
        {% if validateRequestForm is defined %}
            <div id="validateModal" class="modal">
                {{ form_start(validateRequestForm) }}
                <div class="modal-content">
                    <h5>{% trans %}activities.create.validate_title_msg{% endtrans %}</h5>
                    <p>{% trans %}activities.create.validate_content_msg{% endtrans %}</p>
                    {{ form_row(validateRequestForm.activityName) }}
                    {{ form_row(validateRequestForm.activityDescription) }}

                    {{ form_widget(validateRequestForm.ownCreation) }}
                    {{ form_label(validateRequestForm.ownCreation) }}

                    {{ form_widget(validateRequestForm.activityLeader) }}
                    {{ form_label(validateRequestForm.activityLeader) }}

                </div>

                <div class="modal-footer action-buttons">
                    <div class="button-field">
                        <a class=" modal-action modal-close submit-button waves-effect waves-red red btn-large">{% trans %}activities.create.delegate_back_btn_msg{% endtrans %}</a>
                    </div>
                    <div class="button-field">
                        {{ form_row(validateRequestForm.submit) }}
                    </div>
                </div>
                {{ form_rest(validateRequestForm) }}
                {{ form_end(validateRequestForm) }}
            </div>
        {% endif %}
          <div id="cancelModal" class="modal">
              <div class="modal-content">
                  <p>Are you sure you want to delete your request ?</p>
              </div>
              <div class="modal-footer">
                  <a class=" modal-action modal-close submit-button waves-effect waves-green btn-large cancel-button">{% trans %}user_update.delete_modal.confirm{% endtrans %}</a>
                  <a class=" modal-action modal-close waves-effect waves-green btn-flat red-text">{% trans %}user_update.delete_modal.decline{% endtrans %}</a>
              </div>
          </div>
          <div id="discardModal" class="modal">
              <div class="modal-content">
                  <p>{% trans %}activities.reject_request_msg{% endtrans %}</p>
              </div>
              <div class="modal-footer">
                  <a class=" modal-action modal-close submit-button waves-effect waves-green btn-large discard-button">{% trans %}user_update.delete_modal.confirm{% endtrans %}</a>
                  <a class=" modal-action modal-close waves-effect waves-green btn-flat red-text">{% trans %}user_update.delete_modal.decline{% endtrans %}</a>
              </div>
          </div>
          <div id="delegateActivity" class="modal">
              {{ form_start(delegateForm) }}
              <div class="modal-content">
                  <h5>{% trans %}activities.create.delegate_title_msg{% endtrans %}</h5>
                  <p>{% trans %}activities.create.delegate_content_msg{% endtrans %}</p>
                  {{ form_row(delegateForm.activityName) }}
                  {{ form_row(delegateForm.activityDescription) }}
                  {{ form_label(delegateForm.activityLeader) }}
                  {{ form_widget(delegateForm.activityLeader) }}
              </div>

              <div class="modal-footer action-buttons">
                  <div class="button-field">
                      <a class=" modal-action modal-close submit-button waves-effect waves-red red btn-large">{% trans %}activities.create.delegate_back_btn_msg{% endtrans %}</a>
                  </div>
                  <div class="button-field">
                      {{ form_row(delegateForm.submit) }}
                  </div>
              </div>
              {{ form_rest(delegateForm) }}
              {{ form_end(delegateForm) }}
          </div>
          <div id="delegateSuccess" class="modal">
              <div class="modal-content">
                  <p>{% trans %}activities.create.delegate_success_msg{% endtrans %}</p>
              </div>
              <div class="modal-footer">
                  <div class="button-field">
                      <a class="modal-close submit-button waves-effect waves-green btn-large">{% trans %}activities.create.delegate_success_close_btn_msg{% endtrans %}</a>
                  </div>
              </div>
          </div>
          <div id="cancelSuccess" class="modal">
              <div class="modal-content">
                  <p>{% trans %}activities.request.cancel_success_msg{% endtrans %}</p>
              </div>
              <div class="modal-footer">
                  <div class="button-field">
                      <a class="modal-close submit-button waves-effect waves-green btn-large">{% trans %}activities.request.cancel_success_btn_msg{% endtrans %}</a>
                  </div>
              </div>
          </div>
          <div id="discardSuccess" class="modal">
              <div class="modal-content">
                  <p>{% trans %}activities.reject_request_success_msg{% endtrans %}</p>
              </div>
              <div class="modal-footer">
                  <div class="button-field">
                      <a class="modal-close submit-button waves-effect waves-green btn-large">{% trans %}activities.reject_request_success_close_btn_msg{% endtrans %}</a>
                  </div>
              </div>
          </div>
          <div id="validateSuccess" class="modal">
              <div class="modal-content">
                  <p>{% trans %}activities.validate.success_msg{% endtrans %}</p>
              </div>
              <div class="modal-footer">
                  <div class="button-field">
                      <a class="modal-close submit-button waves-effect waves-green btn-large">{% trans %}activities.validate.success_close_btn_msg{% endtrans %}</a>
                  </div>
              </div>
          </div>
    {% endif %}
      {% if currentuser.role == 3 %}
          <div class="action-buttons">
              <div id="cancelModal" class="modal">
                  <div class="modal-content">
                      <p>{% trans %}activities.cancel_request_msg{% endtrans %}</p>
                  </div>
                  <div class="modal-footer">
                      <a class=" modal-action modal-close submit-button waves-effect waves-green btn-large cancel-button">{% trans %}user_update.delete_modal.confirm{% endtrans %}</a>
                      <a class=" modal-action modal-close waves-effect waves-green btn-flat red-text">{% trans %}user_update.delete_modal.decline{% endtrans %}</a>
                  </div>
              </div>
              <div id="cancelSuccess" class="modal">
                  <div class="modal-content">
                      <p>{% trans %}activities.request.cancel_success_msg{% endtrans %}</p>
                  </div>
                  <div class="modal-footer">
                      <div class="button-field">
                          <a class="modal-close submit-button waves-effect waves-green btn-large">{% trans %}activities.request.cancel_success_btn_msg{% endtrans %}</a>
                      </div>
                  </div>
              </div>
          </div>
      {% endif %}

      <div id="archiveSuccess" class="modal">
          <div class="modal-content">
              <p>{% trans %}activities.archive.success_msg{% endtrans %}</p>
          </div>
          <div class="modal-footer action-buttons">
              <div class="button-field">
                  <a class="modal-close waves-effect waves-green btn-large">{% trans %}activities.archive.success_close_btn_msg{% endtrans %}</a>
              </div>
          </div>
      </div>
      <div id="restoreSuccess" class="modal">
          <div class="modal-content">
              <p>{% trans %}activities.restore.success_msg{% endtrans %}</p>
          </div>
          <div class="modal-footer action-buttons">
              <div class="button-field">
                  <a class="modal-close waves-effect waves-green btn-large">{% trans %}activities.restore.success_close_btn_msg{% endtrans %}</a>
              </div>
          </div>
      </div>

  {% if organization.templateActivities|length > 0 %}

     <div id="selectTemplate" class="modal">
         <div class="modal-content">
             <h4>{% trans %}activities.create_from_template.modal_title{% endtrans %}</h4>

             <div id="templateSelector" style="text-align: center">
                 {#<label for="templateSelect" class="required" style="font-size: 1rem; color: black">{% trans %}overview.criterion_type{% endtrans %}</label>#}
                 <select id="templateSelect" style="display: block!important; font-family: Roboto, FontAwesome; margin: auto; width: 65%">
                     {% for template in organization.templateActivities %}
                         <option value="{{ template.id }}" class="cli_option">{{ template.name }}</option>
                     {% endfor %}
                 </select>
             </div>

         </div>
         <div class="modal-footer action-buttons">
             <div class="button-field">
                 <a class="modal-close waves-effect waves-green btn-large template-select">{% trans %}Ok{% endtrans %}</a>
             </div>
         </div>
     </div>

 {% endif %}




{% endblock %}

 {% block javascripts %}
     <script src="{{ asset('js/activities_list.js') }}"></script>
     {% if organization.templateActivities|length > 0 %}
         <script>
             $(function(){
                 $('.template-select').on('click',function(e){
                     e.preventDefault();

                     var templateVal = $(this).closest('.modal').find('select').val();
                     urlToPieces =  createFromTemplateUrl.split('/');
                     urlToPieces[urlToPieces.length-1] = templateVal;
                     var cftUrl = urlToPieces.join('/');

                     $.post(cftUrl,null)
                         .done(function(data){
                             urlToPieces = activityDefinitionUrl.split('/');
                             urlToPieces[urlToPieces.length-2] = data.actId;
                             window.location =  urlToPieces.join('/');
                         })
                         .fail(function(data){
                            console.log(data)
                         })

                 });
             });
         </script>
     {% endif %}
 {% endblock %}
